    {% extends 'sebase.html' %}
    {% load static %}
    {% block title %}Leadership - SimpleEXCHANGE{% endblock %}
    {% block extra_styles %}
<div class="se-enroll-bg">
    <div class="se-enroll-container">
        <div class="se-enroll-logo-wrap text-center mb-4">
            <img src="/staticfiles/simpleexchange.jpg" alt="SimpleExchange Logo" class="se-enroll-logo mb-2" style="max-width:180px; width:100%; height:auto; border-radius:12px; box-shadow:0 2px 12px rgba(30,41,59,0.10);">
        </div>
        <div class="card shadow-lg se-enroll-card">
            <div class="card-body p-5">
                <h1 class="mb-4 se-enroll-title">Exchange Issuance Enrollment</h1>
                <p class="text-muted mb-4 se-enroll-desc">Complete this form to start your 1031 exchange process</p>

            <!-- Success Message (hidden by default) -->
            <div id="successMessage" class="alert alert-success" style="display: none;">
                <h4>âœ“ Exchange Created Successfully!</h4>
                <p>Your Exchange ID is: <strong id="exchangeIdDisplay"></strong></p>
                <p>Redirecting you to your exchange details...</p>
            </div>

            <!-- Error Message (hidden by default) -->
            <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

            <!-- Enrollment Form -->
            <form id="enrollmentForm">
                {% csrf_token %}
                
                <!-- Sale Price -->
                <div class="form-group mb-4">
                    <label for="sale_price" class="form-label fw-bold">
                        Sale Price - Relinquished Asset *
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input 
                            type="number" 
                            class="form-control" 
                            id="sale_price" 
                            name="sale_price" 
                            step="0.01"
                            placeholder="0.00"
                            required
                        >
                    </div>
                    <small class="form-text text-danger" id="sale_price_error"></small>
                </div>

                <!-- Equity Rollover -->
                <div class="form-group mb-4">
                    <label for="equity_rollover" class="form-label fw-bold">
                        Equity Rollover - Replacement 1031 Asset *
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input 
                            type="number" 
                            class="form-control" 
                            id="equity_rollover" 
                            name="equity_rollover" 
                            step="0.01"
                            placeholder="0.00"
                            required
                        >
                    </div>
                    <small class="form-text text-danger" id="equity_rollover_error"></small>
                </div>

                <!-- Relinquish Closing Date -->
                <div class="form-group mb-4">
                    <label for="relinquish_closing_date" class="form-label fw-bold">
                        Relinquish Closing Date *
                    </label>
                    <input 
                        type="date" 
                        class="form-control" 
                        id="relinquish_closing_date" 
                        name="relinquish_closing_date" 
                        required
                    >
                    <small class="form-text text-danger" id="relinquish_closing_date_error"></small>
                </div>

                <!-- Has QI Checkbox -->
                <div class="form-group mb-4">
                    <div class="form-check">
                        <input 
                            type="checkbox" 
                            class="form-check-input" 
                            id="has_qi" 
                            name="has_qi"
                        >
                        <label class="form-check-label fw-bold" for="has_qi">
                            I have a Qualified Intermediary (QI)
                        </label>
                    </div>
                </div>

                <!-- QI Company Name (shows only when has_qi is checked) -->
                <div class="form-group mb-4" id="qi_company_section" style="display: none;">
                    <label for="qi_company_name" class="form-label fw-bold">
                        Qualified Intermediary Company Name *
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="qi_company_name" 
                        name="qi_company_name" 
                        placeholder="Enter QI company name"
                    >
                    <small class="form-text text-danger" id="qi_company_name_error"></small>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn">
                    Submit Enrollment
                </button>

                <p class="text-center text-muted mt-3 mb-0">
                    <small>* Required fields</small>
                </p>
            </form>
        </div>
    </div>
</div>

<script>
// Show/hide QI company name field based on checkbox
document.getElementById('has_qi').addEventListener('change', function() {
    const qiSection = document.getElementById('qi_company_section');
    const qiInput = document.getElementById('qi_company_name');
    
    if (this.checked) {
        qiSection.style.display = 'block';
        qiInput.required = true;
    } else {
        qiSection.style.display = 'none';
        qiInput.required = false;
        qiInput.value = '';
    }
});

// Clear error messages when user types
['sale_price', 'equity_rollover', 'relinquish_closing_date', 'qi_company_name'].forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
        field.addEventListener('input', function() {
            document.getElementById(fieldId + '_error').textContent = '';
        });
    }
});

// Form submission
document.getElementById('enrollmentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Clear previous errors
    document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
    document.getElementById('errorMessage').style.display = 'none';
    
    // Get form data
    const formData = new FormData();
    const salePrice = document.getElementById('sale_price').value;
    const equityRollover = document.getElementById('equity_rollover').value;
    const closingDate = document.getElementById('relinquish_closing_date').value;
    const hasQi = document.getElementById('has_qi').checked;
    const qiCompanyName = document.getElementById('qi_company_name').value;
    
    // Validation
    if (parseFloat(equityRollover) > parseFloat(salePrice)) {
        document.getElementById('equity_rollover_error').textContent = 'Equity rollover cannot exceed sale price';
        return;
    }
    
    if (hasQi && !qiCompanyName.trim()) {
        document.getElementById('qi_company_name_error').textContent = 'Please enter your QI company name';
        return;
    }
    
    // Build form data
    formData.append('sale_price', salePrice);
    formData.append('equity_rollover', equityRollover);
    formData.append('relinquish_closing_date', closingDate);
    formData.append('has_qi', hasQi ? 'true' : 'false');
    formData.append('qi_company_name', qiCompanyName);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Disable submit button
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating Exchange...';
    
    try {
        const response = await fetch('/SE/Exchange/Create/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success message
            document.getElementById('exchangeIdDisplay').textContent = data.exchange_id;
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('enrollmentForm').style.display = 'none';
            
            // Redirect after 2 seconds
            setTimeout(() => {
                window.location.href = `/SE/Exchange/${data.exchange_pk}/`;
            }, 2000);
        } else {
            // Show error message
            document.getElementById('errorMessage').textContent = data.error || 'An error occurred';
            document.getElementById('errorMessage').style.display = 'block';
            
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('errorMessage').textContent = 'Network error. Please try again.';
        document.getElementById('errorMessage').style.display = 'block';
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});
</script>

{% endblock %}