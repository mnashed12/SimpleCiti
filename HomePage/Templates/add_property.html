{% extends 'sebase.html' %}
{% load static %}
{% block title %}Add Property - Simple1031â„¢{% endblock %}
{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/property-forms.css' %}">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSekL7sUKpBHSeA60dOsL7lf6sflnsPpc&libraries=places"></script>
<style>
/* Page-specific overrides and custom styles */
.combined-preview {
    padding: 1.25rem;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    text-align: center;
    border: 2px dashed #cbd5e1;
}

.ai-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.ai-option {
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.4rem;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    background: white;
    transition: all 0.2s ease;
}

.ai-option:hover {
    background: #f1f5f9;
}

.ai-option.selected {
    background: #10b981;
    color: white;
}

.top-suggestion-item {
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    background: white;
    transition: all 0.2s ease;
}

.top-suggestion-item:hover {
    background: #f8fafc;
}

.top-suggestion-item.selected {
    background: #667eea;
    color: white;
}

.btn-use {
    width: 100%;
    padding: 0.75rem;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-use:hover {
    background: #059669;
}

.btn-use:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
}

.date-buttons {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
}

.date-buttons button {
    padding: 0.5rem;
    font-size: 11px;
    border-radius: 6px;
    border: 1px solid #cbd5e1;
    background: white;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
}

.date-buttons button:hover {
    background: #f1f5f9;
}

.date-buttons button.selected {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.image-preview {
    height: 120px;
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
    background: #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: center;
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
</style>
    max-width: 1600px;
    margin: 1rem auto 0.5rem;
    padding: 0 1rem;
}
.back-to-dashboard a {
    display: inline-block;
    padding: 0.6rem 1.2rem;
    font-size: 14px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    font-weight: 600;
}
.back-to-dashboard a:hover {
    opacity: 0.9;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
    background: white;
    padding: 0 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-top: 8vh;
}

/* Header Row with REF and Timeline */
.header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 2rem;
}

.ref-title-section {
    flex: 1;
}
.ref-title-section h1 {
    font-size: 26px;
    font-weight: 900;
    color: #1f2937;
    margin-bottom: 0.5rem;
}
.ref-title-section .ref-number {
    color: #dc2626;
}

.timeline-vertical {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 280px;
}

.timeline-box {
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    font-size: 12px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0.8rem;
    transition: all 0.2s ease;
}

.timeline-box.draft {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}
.timeline-box.review {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white;
}
.timeline-box.published {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.timeline-box-title {
    font-weight: 700;
    font-size: 14px;
}
.timeline-box-info {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
}

/* Tabs - EXTREMELY OBVIOUS ACTIVE STATE */
.tabs {
    display: flex;
    gap: 0;
    margin-bottom: 0;
    justify-content: flex-start;
    align-items: center;
    border-bottom: 3px solid #e5e7eb;
}

/* Left group of tabs */
.tabs-left {
    display: flex;
    gap: 0.5rem;
}

/* Default (inactive) tab */
.tab-btn {
    padding: 0.75rem 2rem;
    border: none;
    background: #ffffff;
    cursor: pointer;
    font-size: 14px;
    border-radius: 10px 10px 0 0;
    border: 2px solid #e5e7eb;
    border-bottom: none;
    font-weight: 600;
    transition: all 0.25s ease;
    color: #9ca3af;
    position: relative;
    margin-bottom: -3px;
    opacity: 0.6;
    filter: grayscale(0.2);
}

.tab-btn:hover {
    background: #f9fafb;
    color: #4b5563;
    opacity: 0.9;
}

/* Active tab - visually dominant */
.tab-btn.active {
    background: white;
    color: #111827;
    border-color: #2563eb;
    font-weight: 800;
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.35);
    transform: scale(1.05) translateY(-4px);
    opacity: 1;
    z-index: 5;
    filter: none;
}

/* Thick glowing top accent bar */
.tab-btn.active::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px;
    background: linear-gradient(to right, #2563eb, #3b82f6);
    border-radius: 10px 10px 0 0;
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
}

/* Summary variant */
.tab-btn.tab-summary {
    color: #1e40af;
    background: #eff6ff;
}

.tab-btn.tab-summary.active {
    border-color: #3b82f6;
}

.tab-btn.tab-summary.active::before {
    background: linear-gradient(to right, #1e3a8a, #3b82f6);
}

/* Details variant */
.tab-btn.tab-details {
    color: #7e22ce;
    background: #f5e1ff;
}

.tab-btn.tab-details.active {
    border-color: #a855f7;
    box-shadow: 0 0 20px rgba(168, 85, 247, 0.35);
}

.tab-btn.tab-details.active::before {
    background: linear-gradient(to right, #9333ea, #a855f7);
}

/* Right side section */
.tabs-right {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-left: 50px;
}

.tabs-right select {
    padding: 0.5rem 1rem;
    font-size: 13px;
    border: 2px solid #667eea;
    border-radius: 6px;
    font-weight: 600;
    background: white;
    cursor: pointer;
}



.tab-content {
    display: none;
    padding-top: 1.5rem;
}

.tab-content.active {
    display: block;
    max-width: 100%;
    width: 1600px;
    margin: 0 auto;
}

/* Form Rows & Groups */
.form-row {
    display: grid;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.form-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-group label {
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
    min-width: fit-content;
    color: #374151;
}

.form-group input, .form-group select, .form-group textarea {
    padding: 0.6rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 13px;
    width: 100%;
    min-width: 0;
    transition: all 0.2s ease;
    background: white;
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-group input[readonly] {
    background: #f9fafb;
    color: #6b7280;
    cursor: not-allowed;
}

.form-group textarea {
    height: 3rem;
    resize: vertical;
    font-family: inherit;
}

/* Form Section - IMPROVED BACKGROUND */
.form-section {
    padding: .2rem;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.btn-ai {
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    white-space: nowrap;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-ai:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.required {
    color: #dc2626;
    font-weight: 700;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #1f2937;
}

.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #9ca3af;
    transition: color 0.2s;
}

.modal-close:hover {
    color: #ef4444;
}

.ai-instructions {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #f3f4f6;
    border-radius: 6px;
}

.ai-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.ai-column h3 {
    font-size: 13px;
    margin-bottom: 0.75rem;
    color: #1f2937;
    font-weight: 700;
}

.ai-option {
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.4rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    font-size: 11px;
    background: white;
    transition: all 0.2s ease;
}

.ai-option:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
}

.ai-option.selected {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.combined-preview {
    padding: 1.25rem;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    text-align: center;
    border: 2px dashed #d1d5db;
}

.combined-preview-label {
    font-size: 10px;
    color: #9ca3af;
    margin-bottom: 0.5rem;
    font-weight: 600;
    letter-spacing: 0.05em;
}

.combined-preview-text {
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
    min-height: 28px;
}

.top-suggestions {
    margin-bottom: 1.5rem;
}

.top-suggestions h3 {
    font-size: 13px;
    margin-bottom: 0.75rem;
    color: #1f2937;
    font-weight: 700;
}

.top-suggestion-item {
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    background: white;
    transition: all 0.2s ease;
}

.top-suggestion-item:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
}

.top-suggestion-item.selected {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.btn-use {
    width: 100%;
    padding: 0.75rem;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-use:hover {
    background: #059669;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-use:disabled {
    background: #d1d5db;
    cursor: not-allowed;
    transform: none;
}

.ai-generated {
    background: #d1fae5 !important;
    border-color: #10b981 !important;
}

.image-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.75rem;
    margin-top: 1rem;
}

.image-box {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 2rem 1rem;
    text-align: center;
    cursor: pointer;
    font-size: 11px;
    color: #9ca3af;
    transition: all 0.2s ease;
}

.image-box:hover {
    border-color: #10b981;
    background: #f0fdf4;
}

.image-box.required {
    border-color: #ef4444;
}

.doc-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
    margin-top: 1rem;
}

.doc-box {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    font-size: 11px;
    background: white;
    transition: all 0.2s ease;
    color: #6b7280;
    font-weight: 500;
}

.doc-box:hover {
    border-color: #10b981;
    background: #f0fdf4;
}

.doc-warning {
    background: #fef3c7;
    border: 1px solid #fbbf24;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.75rem;
    font-size: 11px;
    color: #92400e;
}

.action-buttons {
    text-align: center;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 3px solid #e5e7eb;
}

.btn-submit {
    padding: 0.75rem 2.5rem;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: #000;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    margin-right: 0.75rem;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
}

.btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
}

.btn-publish {
    padding: 0.75rem 2.5rem;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    margin-right: 0.75rem;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.btn-publish:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.btn-pipeline {
    padding: 0.75rem 2.5rem;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.btn-pipeline:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.hero-generator {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    padding: 1.5rem;
    border-radius: 12px;
    border: 2px solid #3b82f6;
    margin: 1.5rem 0;
}

.detail-header {
    font-size: 16px;
    margin: auto 0;
    font-weight: 700;
    color: #1f2937;
}

/* INPUT FIELD SIZING - PROPERLY SCALED */
.w-tiny { max-width: 80px !important; min-width: 80px !important; }
.w-small { max-width: 120px !important; min-width: 120px !important; }
.w-medium { max-width: 200px !important; min-width: 200px !important; }
.w-large { max-width: 300px !important; min-width: 300px !important; }
.w-full { max-width: 100% !important; }

/* Date Input Wrapper */
.date-input-wrapper {
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
}

.date-buttons {
    display: grid;
    grid-template-columns: repeat(3, auto); /* 2 columns max */
    grid-auto-rows: auto;                   /* buttons take natural height */
    gap: 0.4rem;
    max-height: none;                       /* let grid size itself */
}

/* Optional: limit to 3 rows (6 buttons total) */
.date-buttons > :nth-child(n+7) {
    display: none;
}

.date-buttons button {
    padding: 0.35rem 0.65rem;
    font-size: 11px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background-color: white;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    color: #6b7280;
}

.date-buttons button:hover {
    background-color: #f3f4f6;
    border-color: #9ca3af;
    transform: translateY(-1px);
}

.date-buttons button.selected {
    background: #10b981 !important;
    color: white !important;
    font-weight: 700;
    border-color: #10b981 !important;
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.section-title {
    font-size: 20px;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 1.5rem;
    text-align: center;
}

.image-management-container {
    width: 100%;
    margin-top: 1.5rem;
}

.image-grid-manager {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-gap: 1rem;
}

.image-upload-box {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 0.75rem;
    background: #fafafa;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: all 0.2s ease;
}

.image-upload-box:hover {
    border-color: #10b981;
    background: #f0fdf4;
}

.image-box-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 10px;
    font-weight: bold;
    color: #6b7280;
}

.image-preview {
    height: 120px;
    width: 100%;
    border-radius: 6px;
    overflow: hidden;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-placeholder {
    text-align: center;
    color: #9ca3af;
    font-size: 12px;
    font-weight: 500;
}

.image-filename {
    margin-top: 0.5rem;
    font-size: 10px;
    text-align: center;
    word-break: break-word;
    color: #6b7280;
}

.image-upload-box.empty {
    cursor: pointer;
}

.image-upload-box.filled {
    background: #f0f9ff;
    border-color: #10b981;
}

.btn-remove {
    z-index: 10;
}

/* Required field styling */
.required-field {
    border: 2px solid #ef4444 !important;
    background-color: #fef2f2 !important;
}

.required-field:focus {
    border-color: #dc2626 !important;
    background-color: #fff !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
}

.required-field.filled {
    border: 1px solid #d1d5db !important;
    background-color: #fff !important;
}

.required-field.filled:focus {
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
}
</style>
{% endblock %}
{% block content %}
<div class="container">
    <!-- Header Row: REF/Title on left, Timeline on right -->
    <div class="header-row">
        <div class="ref-title-section">
            <h1>
                <span class="ref-number">NEW PROPERTY</span> -
                <span id="marketingTitleDisplay">Not Set</span>
            </h1>
        </div>
        <div class="timeline-vertical">
            <div class="timeline-box draft">
                <div class="timeline-box-title">Draft - <span id="progressPercent">0</span>%</div>
                <div class="timeline-box-info">In Progress</div>
            </div>
            <div class="timeline-box published">
                <div class="timeline-box-title">Published</div>
                <div class="timeline-box-info">Awaiting</div>
            </div>
        </div>
    </div>
    <!-- Tabs Row with Controls -->
    <div class="tabs">
        <div class="tabs-left">
            <button class="tab-btn tab-summary active" onclick="switchTab('summary', event)">Summary</button>
            <button class="tab-btn tab-details" onclick="switchTab('details', event)">Details</button>
        </div>
        <div class="tabs-right">
            <select id="assetClass" onchange="updateRefNum()">
                <option value="">Asset Class...</option>
                <option value="SB">SB - Small Bay/Flex - 1000</option>
                <option value="IN">IN - Industrial - 2000</option>
                <option value="MF">MF - Multi-Family - 3000</option>
                <option value="OF">OF - Office - 4000</option>
                <option value="RT">RT - Retail - 5000</option>
                <option value="HT">HT - Hotel - 6000</option>
                <option value="MA">MA - Marina - 7000</option>
                <option value="SS">SS - Self Storage - 8000</option>
                <option value="MS">MS - Misc. - 9000</option>
            </select>
            <select id="dealStatus" name="deal_stage">
                <option>Deal Status...</option>
                <option>LOI Out</option>
                <option>Under LOI</option>
                <option>Under Due Diligence</option>
                <option>Hard Deposit</option>
                <option>Closing Scheduled</option>
                <option>CLOSED</option>
            </select>
        </div>
    </div>
    <!-- SUMMARY TAB -->
    <form method="POST" action="{% url 'add_property' %}" id="propertyIntakeForm">
        {% csrf_token %}
        <input type="hidden" id="propertyType" name="property_type" value="">
        <input type="hidden" id="title" name="title" value="">
        <div id="summary" class="tab-content active">
            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:1rem; border-radius:8px; margin-bottom:1rem; text-align:center; font-size:13px; font-weight:600;">
                 Only Visible to Clients with Down Payment
            </div>
            <div class="doc-grid">
                <div class="doc-box" onclick="uploadDoc('om')" ondrop="handleDrop(event, 'om')" ondragover="handleDragOver(event)">
                     <strong>Offering Memorandum</strong><br>Drag & drop or click
                </div>
                <div class="doc-box" onclick="uploadDoc('rentroll')" ondrop="handleDrop(event, 'rentroll')" ondragover="handleDragOver(event)">
                     <strong>Rent Roll</strong><br>Drag & drop or click
                </div>
                <div class="doc-box" onclick="uploadDoc('proforma')" ondrop="handleDrop(event, 'proforma')" ondragover="handleDragOver(event)">
                     <strong>Pro Forma</strong><br>Drag & drop or click
                </div>
                <div class="doc-box" onclick="uploadDoc('tic')" ondrop="handleDrop(event, 'tic')" ondragover="handleDragOver(event)">
                     <strong>TIC Agreement</strong><br>Drag & drop or click
                </div>
                <div class="doc-box" onclick="uploadDoc('environmental')" ondrop="handleDrop(event, 'environmental')" ondragover="handleDragOver(event)">
                     <strong>Environmental Report</strong><br>Drag & drop or click
                </div>
            </div>
            <div class="doc-grid">
                <div class="doc-box" onclick="uploadDoc('legal')" ondrop="handleDrop(event, 'legal')" ondragover="handleDragOver(event)">
                     <strong>Legal Opinion</strong><br>Drag & drop or click
                </div>
                <div class="doc-box" onclick="uploadDoc('operating')" ondrop="handleDrop(event, 'operating')" ondragover="handleDragOver(event)">
                     <strong>Operating Statements</strong><br>Drag & drop or click
                </div>
                <div class="doc-box" onclick="uploadDoc('market')" ondrop="handleDrop(event, 'market')" ondragover="handleDragOver(event)">
                     <strong>Market Research</strong><br>Drag & drop or click
                </div>
                <div class="doc-box" onclick="uploadDoc('brochure')" ondrop="handleDrop(event, 'brochure')" ondragover="handleDragOver(event)">
                     <strong>Marketing Brochure</strong><br>Drag & drop or click
                </div>
                <div class="doc-box" onclick="uploadDoc('other')" ondrop="handleDrop(event, 'other')" ondragover="handleDragOver(event)">
                     <strong>Other</strong><br>Drag & drop or click
                </div>
            </div>
            <!-- Key Dates -->
            <div class="form-section">
                <div class="form-row" style="display:flex; gap:2rem;">
                    <h1 class="detail-header">Key Dates</h1>
                    <div class="form-group">
                        <label>LOI Date</label>
                        <div class="date-input-wrapper">
                            <input type="date" id="loiDate" name="loi_date" value="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>PSA Date</label>
                        <div class="date-input-wrapper">
                            <input type="date" id="psaDate" name="psa_date" value="">
                            <div class="date-buttons">
                                <button type="button" onclick="addDaysTo('loiDate', 'psaDate', 5)">+5</button>
                                <button type="button" onclick="addDaysTo('loiDate', 'psaDate', 10)">+10</button>
                                <button type="button" onclick="addDaysTo('loiDate', 'psaDate', 20)">+20</button>
                                <button type="button" onclick="addDaysTo('loiDate', 'psaDate', 30)">+30</button>
                                <button type="button" onclick="addDaysTo('loiDate', 'psaDate', 45)">+45</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>DD End</label>
                        <div class="date-input-wrapper">
                            <input type="date" id="ddEnd" name="dd_end_date" value="">
                            <div class="date-buttons">
                                <button type="button" onclick="addDaysTo('psaDate', 'ddEnd', 20)">+20</button>
                                <button type="button" onclick="addDaysTo('psaDate', 'ddEnd', 30)">+30</button>
                                <button type="button" onclick="addDaysTo('psaDate', 'ddEnd', 45)">+45</button>
                                <button type="button" onclick="addDaysTo('psaDate', 'ddEnd', 60)">+60</button>
                                <button type="button" onclick="addDaysTo('psaDate', 'ddEnd', 90)">+90</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Closing Date <span class="required">*</span></label>
                        <div class="date-input-wrapper">
                            <input type="date" id="closingDate" name="close_date" value="" onblur="updateProgress()">
                            <div class="date-buttons">
                                <button type="button" onclick="addDaysTo('ddEnd', 'closingDate', 10)">+10</button>
                                <button type="button" onclick="addDaysTo('ddEnd', 'closingDate', 20)">+20</button>
                                <button type="button" onclick="addDaysTo('ddEnd', 'closingDate', 30)">+30</button>
                                <button type="button" onclick="addDaysTo('ddEnd', 'closingDate', 45)">+45</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Property Info -->
            <h1 class="detail-header" style="padding-top: .5rem">Property</h1>
            <div class="form-row" style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                <div class="form-group">
                    <label>Address <span class="required">*</span></label>
                    <input type="text" id="address" name="address" class="w-full" placeholder="900 Stewart Avenue" value="" onblur="fillSubmarket(); updateProgress();">
                </div>
                <div class="form-group">
                    <label>City <span class="required">*</span></label>
                    <input type="text" id="city" name="city" class="w-small" placeholder="Garden City" value="" onblur="fillSubmarket(); updateProgress();">
                </div>
                <div class="form-group">
                    <label>State <span class="required">*</span></label>
                    <input type="text" id="state" name="state" class="w-tiny" placeholder="NY" maxlength="2" value="" style="text-transform: uppercase;" onblur="fillSubmarket(); updateProgress();" oninput="this.value = this.value.toUpperCase();">
                </div>
                <div class="form-group">
                    <label>ZIP</label>
                    <input type="text" id="zip" name="zip_code" class="w-tiny" placeholder="11530" value="">
                </div>
                <div class="form-group">
                    <label>SF</label>
                    <input type="text" id="sf" name="total_sf" class="w-tiny" placeholder="75,000" value="" onblur="formatNumber(this); updateProgress();">
                </div>
                <div class="form-group">
                    <label>Acres</label>
                    <input type="text" id="acres" name="acres" class="w-tiny" placeholder="4.5" value="">
                </div>
                <div class="form-group">
                    <label>Submarket</label>
                    <input type="text" id="submarket" name="submarket" class="w-medium" placeholder="Auto-filled" value="" readonly>
                </div>
                <div class="form-group" style="flex: 1; min-width: 300px;">
                    <label style="align-self: flex-start; margin-top: 0.5rem;">Location Highlights</label>
                    <input type="text" id="locationHighlights" name="location_highlights" placeholder="Near major highways, airport access..." value="" style="flex: 1;">
                </div>
            </div>
            <!-- Financial Info -->
            <h1 class="detail-header">Financials</h1>
            <div class="form-section">
                <div class="form-row" style="grid-template-columns: 0.7fr 0.5fr 0.7fr 0.7fr 0.6fr 0.5fr 0.5fr;">
                    <div class="form-group">
                        <label>Acquisition Price <span class="required">*</span></label>
                        <input type="text" id="purchasePrice" name="purchase_price" placeholder="$5,000,000" value="" onblur="formatCurrency(this); calcAll();">
                    </div>
                    <div class="form-group">
                        <label>LTV % <span class="required">*</span></label>
                        <input type="text" id="ltv" name="ltv" placeholder="65%" value="" onblur="formatPercentage(this); calcAll();">
                    </div>
                    <div class="form-group">
                        <label>Debt</label>
                        <input type="text" id="debt" name="debt_amount" placeholder="Auto-calc" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label>Equity</label>
                        <input type="text" id="totalEquity" name="total_equity" placeholder="Auto-calc" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label>Cap Rate</label>
                        <input type="text" id="capRate" name="cap_rate" placeholder="Auto-calc" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label>NOI <span class="required">*</span></label>
                        <input type="text" id="noi" name="current_noi" placeholder="$550,000" value="" onblur="formatCurrency(this); calcAll();">
                    </div>
                    <div class="form-group">
                        <label>IRR (5yr)</label>
                        <input type="text" id="irr" name="projected_irr" placeholder="18.5%" value="" onblur="formatPercentage(this);">
                    </div>
                </div>
            </div>
            <!-- KBIs -->
            <div class="form-section">
                <div class="form-row" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="form-group">
                        <label>Key Business Initiative #1 <span class="required">*</span></label>
                        <select id="kbi1" name="kbi_1" onchange="updateProgress(); updateKBIOptions()">
                            <option value="">Select...</option>
                            <optgroup label="FINANCIAL">
                                <option>Lease-Up Vacant Space</option>
                                <option>Raise Rents to Market</option>
                                <option>Convert to NNN Leases</option>
                                <option>Extend and Improve Leases</option>
                                <option>Monetize Excess Land</option>
                                <option>Refinance to Unlock Equity</option>
                            </optgroup>
                            <optgroup label="OPERATIONAL">
                                <option>Drive Operating Efficiencies</option>
                                <option>Strengthen Tenant Mix</option>
                                <option>Optimize Expense Recovery</option>
                                <option>Upgrade Tenant Quality</option>
                                <option>Streamline Management Systems</option>
                                <option>Improve Collections and Controls</option>
                            </optgroup>
                            <optgroup label="PROPERTY">
                                <option>Modernize and Rebrand Property</option>
                                <option>Upgrade Roof and Pavement</option>
                                <option>Improve Site Access and Parking</option>
                                <option>Add Tenant Amenities</option>
                                <option>Enhance Curb Appeal</option>
                                <option>Upgrade Building Systems</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Key Business Initiative #2</label>
                        <select id="kbi2" name="kbi_2" onchange="updateKBIOptions()">
                            <option value="">Select...</option>
                            <optgroup label="FINANCIAL">
                                <option>Lease-Up Vacant Space</option>
                                <option>Raise Rents to Market</option>
                                <option>Convert to NNN Leases</option>
                                <option>Extend and Improve Leases</option>
                                <option>Monetize Excess Land</option>
                                <option>Refinance to Unlock Equity</option>
                            </optgroup>
                            <optgroup label="OPERATIONAL">
                                <option>Drive Operating Efficiencies</option>
                                <option>Strengthen Tenant Mix</option>
                                <option>Optimize Expense Recovery</option>
                                <option>Upgrade Tenant Quality</option>
                                <option>Streamline Management Systems</option>
                                <option>Improve Collections and Controls</option>
                            </optgroup>
                            <optgroup label="PROPERTY">
                                <option>Modernize and Rebrand Property</option>
                                <option>Upgrade Roof and Pavement</option>
                                <option>Improve Site Access and Parking</option>
                                <option>Add Tenant Amenities</option>
                                <option>Enhance Curb Appeal</option>
                                <option>Upgrade Building Systems</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Key Business Initiative #3</label>
                        <select id="kbi3" name="kbi_3" onchange="updateKBIOptions()">
                            <option value="">Select...</option>
                            <optgroup label="FINANCIAL">
                                <option>Lease-Up Vacant Space</option>
                                <option>Raise Rents to Market</option>
                                <option>Convert to NNN Leases</option>
                                <option>Extend and Improve Leases</option>
                                <option>Monetize Excess Land</option>
                                <option>Refinance to Unlock Equity</option>
                            </optgroup>
                            <optgroup label="OPERATIONAL">
                                <option>Drive Operating Efficiencies</option>
                                <option>Strengthen Tenant Mix</option>
                                <option>Optimize Expense Recovery</option>
                                <option>Upgrade Tenant Quality</option>
                                <option>Streamline Management Systems</option>
                                <option>Improve Collections and Controls</option>
                            </optgroup>
                            <optgroup label="PROPERTY">
                                <option>Modernize and Rebrand Property</option>
                                <option>Upgrade Roof and Pavement</option>
                                <option>Improve Site Access and Parking</option>
                                <option>Add Tenant Amenities</option>
                                <option>Enhance Curb Appeal</option>
                                <option>Upgrade Building Systems</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Key Business Initiative #4</label>
                        <select id="kbi4" name="kbi_4" onchange="updateKBIOptions()">
                            <option value="">Select...</option>
                            <optgroup label="FINANCIAL">
                                <option>Lease-Up Vacant Space</option>
                                <option>Raise Rents to Market</option>
                                <option>Convert to NNN Leases</option>
                                <option>Extend and Improve Leases</option>
                                <option>Monetize Excess Land</option>
                                <option>Refinance to Unlock Equity</option>
                            </optgroup>
                            <optgroup label="OPERATIONAL">
                                <option>Drive Operating Efficiencies</option>
                                <option>Strengthen Tenant Mix</option>
                                <option>Optimize Expense Recovery</option>
                                <option>Upgrade Tenant Quality</option>
                                <option>Streamline Management Systems</option>
                                <option>Improve Collections and Controls</option>
                            </optgroup>
                            <optgroup label="PROPERTY">
                                <option>Modernize and Rebrand Property</option>
                                <option>Upgrade Roof and Pavement</option>
                                <option>Improve Site Access and Parking</option>
                                <option>Add Tenant Amenities</option>
                                <option>Enhance Curb Appeal</option>
                                <option>Upgrade Building Systems</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
               <div class="form-row" style="grid-template-columns: 3fr 1fr; margin-top: 0.3rem;">
                <div class="form-group">
                    <label style="align-self: flex-start; margin-top: 0.3rem;">Business Plan <span class="required">*</span></label>
                    <textarea id="businessPlan" name="business_plan" placeholder="Describe the value-add strategy and exit plan..." onblur="updateProgress()"></textarea>
                </div>
                <div class="form-group">
                    <label>Marketing Title</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button type="button" class="btn-ai" onclick="showAISuggest()" style="padding:0.4rem 0.6rem; font-size:11px;">AI Title</button>
                        <input type="text" id="marketingTitle" name="marketing_title" placeholder="3-6 words" value="" style="flex: 1; padding:0.5rem 0.7rem; font-size:13px; border:1px solid #ccc; border-radius:3px;" onblur="updateMarketingTitleDisplay();">
                    </div>
                </div>
            </div>
            </div>
        </div>
        </div>
        <!-- DETAILS TAB -->
        <div id="details" class="tab-content">
             <h1 class="detail-header">Annual Cash Flow</h1>
            <div class="form-section">
                <div class="form-row" style="grid-template-columns: 1.5fr 1fr 1fr 1.5fr;">
                    <div class="form-group">
                        <label>Coupon</label>
                        <input type="text" id="estAnnualCashFlow" name="est_annual_cash_flow" placeholder="$50,000" value="" onblur="formatCurrency(this); calcCashOnCash();">                    </div>
                        <div class="form-group">
                            <label>Per $100k Equity Investment</label>
                            <input type="text" id="per100k" name="per_100k" placeholder="Auto-calc" value="">
                        </div>
                        <div class="form-group">
                            <label>Cash on Cash</label>
                            <input type="text" id="estCashOnCash" name="est_cash_on_cash" placeholder="Auto-calc" value="">
                        </div>
                    <div class="form-group">
                        <label>Distribution Frequency</label>
                        <select id="distFrequency" name="distribution_frequency">
                            <option value="">Select...</option>
                            <option>Monthly</option>
                            <option selected>Quarterly</option>
                            <option>Semi-Annually</option>
                            <option>Annually</option>
                            <option>At Exit</option>
                        </select>
                    </div>
                </div>
            </div>
            <h1 class="detail-header">Tenancy</h1>
            <div class="form-section">
                <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1.5fr;">
                    <div class="form-group">
                        <label># of Tenants</label>
                        <input type="text" id="numTenants" name="num_tenants" placeholder="5" value="">
                    </div>
                    <div class="form-group">
                        <label>Occupancy %</label>
                        <input type="text" id="occupancy" name="occupancy_percent" placeholder="85%" value="">
                    </div>
                    <div class="form-group">
                        <label>WALT (years)</label>
                        <input type="text" id="walt" name="walt" placeholder="3.5" value="">
                    </div>
                </div>
            </div>
            <!-- Top Tenant 1 -->
            <div class="form-section">
                <div class="form-row" style="grid-template-columns: 1fr .5fr .5fr .5fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Top Tenant 1</label>
                        <input type="text" id="tenant1Name" name="tenant_1_name" placeholder="Walgreens" value="">
                    </div>
                    <div class="form-group">
                        <label>SF Leased</label>
                        <input type="text" id="tenant1SF" name="tenant_1_sf" placeholder="14,500" value="" oninput="calcTenantPct(1)" onblur="formatNumber(this);">
                    </div>
                    <div class="form-group">
                        <label>% of NRA</label>
                        <input type="text" id="tenant1Pct" name="tenant_1_percent" placeholder="Auto-calc" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label>Lease Expiry Date</label>
                        <input type="date" id="tenant1Expiry" name="tenant_1_expiry" value="">
                    </div>
                    <div class="form-group">
                        <label>Lease Structure</label>
                        <select id="tenant1LeaseStructure" name="tenant_1_lease_structure">
                            <option value="">Select...</option>
                            <option>Gross</option>
                            <option>Modified Gross</option>
                            <option>NN</option>
                            <option>NNN</option>
                            <option>Mixed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Corp/Personal Guar</label>
                        <select id="tenant1Guarantee" name="tenant_1_guarantee">
                            <option value="">Select...</option>
                            <option>Yes</option>
                            <option>No</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: 1fr .5fr .5fr .5fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Top Tenant 2</label>
                        <input type="text" id="tenant2Name" name="tenant_2_name" placeholder="LA Fitness" value="">
                    </div>
                    <div class="form-group">
                        <label>SF Leased</label>
                        <input type="text" id="tenant2SF" name="tenant_2_sf" placeholder="35,000" value="" oninput="calcTenantPct(2)" onblur="formatNumber(this);">
                    </div>
                    <div class="form-group">
                        <label>% of NRA</label>
                        <input type="text" id="tenant2Pct" name="tenant_2_percent" placeholder="Auto-calc" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label>Lease Expiry Date</label>
                        <input type="date" id="tenant2Expiry" name="tenant_2_expiry" value="">
                    </div>
                    <div class="form-group">
                        <label>Lease Structure</label>
                        <select id="tenant2LeaseStructure" name="tenant_2_lease_structure">
                            <option value="">Select...</option>
                            <option>Gross</option>
                            <option>Modified Gross</option>
                            <option>NN</option>
                            <option>NNN</option>
                            <option>Mixed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Corp/Personal Guar</label>
                        <select id="tenant2Guarantee" name="tenant_2_guarantee">
                            <option value="">Select...</option>
                            <option>Yes</option>
                            <option>No</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: 1fr .5fr .5fr .5fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Top Tenant 3</label>
                        <input type="text" id="tenant3Name" name="tenant_3_name" placeholder="Target" value="">
                    </div>
                    <div class="form-group">
                        <label>SF Leased</label>
                        <input type="text" id="tenant3SF" name="tenant_3_sf" placeholder="125,000" value="" oninput="calcTenantPct(3)" onblur="formatNumber(this);">
                    </div>
                    <div class="form-group">
                        <label>% of NRA</label>
                        <input type="text" id="tenant3Pct" name="tenant_3_percent" placeholder="Auto-calc" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label>Lease Expiry Date</label>
                        <input type="date" id="tenant3Expiry" name="tenant_3_expiry" value="">
                    </div>
                    <div class="form-group">
                        <label>Lease Structure</label>
                        <select id="tenant3LeaseStructure" name="tenant_3_lease_structure">
                            <option value="">Select...</option>
                            <option>Gross</option>
                            <option>Modified Gross</option>
                            <option>NN</option>
                            <option>NNN</option>
                            <option>Mixed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Corp/Personal Guar</label>
                        <select id="tenant3Guarantee" name="tenant_3_guarantee">
                            <option value="">Select...</option>
                            <option>Yes</option>
                            <option>No</option>
                        </select>
                    </div>

                </div>
            </div>
            <div class="form-section">
                <div class="form-row" style="grid-template-columns: 1fr;">
                    <div class="form-group">
                        <label style="align-self: flex-start; margin-top: 0.3rem; color:red;">Tenancy Hero Comments</label>
                        <textarea id="tenancyhero" name="tenancy_hero" placeholder="Additional comments for tenancy">{{ property.tenancy_hero }}</textarea>
                    </div>
                </div>
            </div>
            <div class="form-section">
                <div class="form-row" style="grid-template-columns: 1fr;">
                    <div class="form-group">
                        <label style="align-self: flex-start; margin-top: 0.3rem; color:red;">Internal Eyes Only<br>Internal Notes</label>
                        <textarea id="internalNotes" name="internal_notes" placeholder="Any internal comments or special considerations..."></textarea>
                    </div>
                </div>
            </div>
            <!-- Broker Info -->
            <h1 class="detail-header">Broker</h1>
            <div class="form-section">
                <div class="form-row" style="grid-template-columns: 1fr 1.2fr 0.7fr 1.2fr .5fr;">
                    <div class="form-group">
                        <label>Broker Name</label>
                        <input type="text" id="brokerName" name="broker_name" placeholder="John Smith" value="">
                    </div>
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" id="brokerCompany" name="broker_company" placeholder="ABC Realty" value="">
                    </div>
                    <div class="form-group">
                        <label>Broker Cell</label>
                        <input type="text" id="brokerCell" name="broker_cell" oninput="formatPhone(this)" placeholder="(555) 987-6543" value="">
                    </div>
                    <div class="form-group">
                        <label>Broker Email</label>
                        <input type="email" id="brokerEmail" name="broker_email" placeholder="broker@company.com" value="">
                    </div>
                    <div class="form-group">
                        <label>Commission %</label>
                        <input type="text" id="commission" name="commission" placeholder="2%" value="">
                    </div>
                </div>
            </div>
            <!-- Hero Summary Generator -->
            <div class="hero-generator">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <label style="font-size: 13px; white-space: nowrap; font-weight: 600; min-width: 110px;">Hero Summary</label>
                    <input type="text" id="heroSummary" name="hero_summary" placeholder="Click Generate to auto-create from fields above" value="" style="flex: 1; padding: 0.6rem; font-size: 13px; border: 1px solid #ccc; border-radius: 4px;">
                    <button type="button" class="btn-ai" onclick="generateHeroSummary()" style="white-space: nowrap; padding: 0.6rem 1.5rem; font-size: 13px; font-weight: 600;">Generate</button>
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 0.5rem; text-align: center;">Fill in fields above, then click Generate to auto-create marketing summary</div>
            </div>
<!-- Images Section at bottom of Details tab -->
<div class="section-divider">
    <h2 class="section-title">Property Images</h2>
</div>

<div id="imageUploadSection" class="image-management-container" style="display: none;">
    <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
        <p style="font-size: 13px; font-weight: 600; color: #1976d2; margin-bottom: 0.5rem;">
            Property Created! Now add up to 10 images
        </p>
        <p style="font-size: 11px; color: #666;">
            Drag & drop or click to upload images. JPG, PNG, GIF, or WebP only.
        </p>
    </div>

    <!-- Bulk Upload -->
    <div style="margin-bottom: 1.5rem; text-align: center;">
        <input type="file" id="bulkImageUpload" accept="image/*" multiple style="display: none;">
        <button type="button" onclick="document.getElementById('bulkImageUpload').click()" class="btn-ai" style="padding: 0.6rem 2rem; font-size: 13px;">
            Upload Multiple Images
        </button>
        <p style="font-size: 10px; color: #666; margin-top: 0.5rem;">Select up to 10 images at once</p>
    </div>

    <!-- Image Grid (10 slots) -->
    <div class="image-grid-manager" id="imageGridManager">
        <!-- Slots 1-10 will be dynamically generated -->
    </div>
</div>

<div id="noPropertyMessage" class="image-management-container">
    <div style="background: #fff3cd; padding: 2rem; border-radius: 8px; text-align: center;">
        <p style="font-size: 14px; font-weight: 600; color: #856404; margin-bottom: 0.5rem;">
            Save property first to upload images
        </p>
        <p style="font-size: 12px; color: #666;">
            Click "Create Property (Save as Draft)" button above, then you can add images.
        </p>
    </div>
</div>
        </div>


        </div>
            <!-- Action Buttons for Details Tab -->
            <div class="action-buttons">
                {% if is_staff or can_submit %}
                    <button type="button" class="btn-submit" onclick="submitForReview()">Create Property (Save as Draft)</button>
                {% endif %}
                {% if can_publish %}
                    <button type="button" class="btn-publish" onclick="approveAndPublish()">Approve & Publish Live</button>
                {% endif %}
            </div>
        </div>
    </form>
</div>
<!-- AI Modal -->
<div id="aiModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeAIModal()">Ã—</button>
        <div class="modal-title">AI Marketing Title Suggestions</div>
        <div class="ai-instructions">
            Select one descriptor from Part 1 and one noun from Part 2, or choose from our top suggestions below. The title will automatically include the city and state.
        </div>
        <div class="top-suggestions">
            <h3> Top Suggestions</h3>
            <div id="topSuggestionsList"></div>
        </div>
        <div class="ai-columns">
            <div class="ai-column">
                <h3>Part 1: Descriptors</h3>
                <div id="part1Options"></div>
            </div>
            <div class="ai-column">
                <h3>Part 2: Property Type</h3>
                <div id="part2Options"></div>
            </div>
        </div>
        <div class="combined-preview">
            <div class="combined-preview-label">PREVIEW</div>
            <div class="combined-preview-text" id="combinedPreview">Select from Part 1 and Part 2</div>
        </div>
        <button id="useNameBtn" class="btn-use" onclick="useSelectedName()" disabled>Use This Title</button>
    </div>
</div>
<script>
let selectedPart1 = '';
let selectedPart2 = '';
let selectedTopSuggestion = '';
let isFeatured = false;
let currentPropertyId = null;
let uploadedImages = [];
const MAX_IMAGES = 10;

// Initialize image grid on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Add Property Form Initialized');
    updateProgress();
    initializeImageGrid();
});

// Initialize the 10 image upload slots with custom headers
function initializeImageGrid() {
    const grid = document.getElementById('imageGridManager');
    if (!grid) return;
    grid.innerHTML = '';

    // Define custom headers for each slot
    const headers = [
        "External - Front",
        "External - Front or Side",
        "External - Front or Side",
        "External - Front or Side",
        "Internal - Docks/Ceilings/Doors/Offices/Bathrooms/etc",
        "Internal - Docks/Ceilings/Doors/Offices/Bathrooms/etc",
        "Yard/Lot",
        "Yard/Lot",
        "Google Earth",
        "Google Maps"
    ];

    for (let i = 1; i <= MAX_IMAGES; i++) {
        const slot = document.createElement('div');
        slot.className = 'image-upload-box empty';
        slot.id = `image-slot-${i}`;
        slot.setAttribute('data-slot', i);
        slot.innerHTML = `
            <div class="image-box-header">
                <div class="image-number">${headers[i - 1]}</div>
            </div>
            <div class="image-preview" id="preview-${i}">
                <div class="image-placeholder">
                    <br>Click or Drag
                </div>
            </div>
            <input type="file" id="upload-${i}" accept="image/*" style="display: none;" onchange="handleSingleImageUpload(event, ${i})">
            <div class="image-filename" id="filename-${i}"></div>
        `;
        // Click to upload
        slot.onclick = function(e) {
            if (e.target.classList.contains('btn-remove')) return;
            document.getElementById(`upload-${i}`).click();
        };
        // Drag and drop
        slot.ondragover = handleImageDragOver;
        slot.ondragleave = handleImageDragLeave;
        slot.ondrop = (e) => handleImageDrop(e, i);
        grid.appendChild(slot);
    }

    // Setup bulk upload listener
    const bulkUpload = document.getElementById('bulkImageUpload');
    if (bulkUpload) {
        bulkUpload.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);

            if (files.length === 0) return;

            // Check how many slots are available
            const availableSlots = MAX_IMAGES - uploadedImages.length;

            if (files.length > availableSlots) {
                alert(`You can only upload ${availableSlots} more image(s). Maximum is ${MAX_IMAGES} total.`);
                return;
            }

            // Upload each file to the next available slot
            files.forEach((file, index) => {
                const nextSlot = uploadedImages.length + 1;
                if (nextSlot <= MAX_IMAGES) {
                    setTimeout(() => uploadImageFile(file, nextSlot), index * 500);
                }
            });

            // Clear the input
            e.target.value = '';
        });
    }
}

// Handle drag over
function handleImageDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.style.borderColor = '#22c55e';
    e.currentTarget.style.background = '#f0fff4';
}

// Handle drag leave
function handleImageDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.style.borderColor = '#ccc';
    e.currentTarget.style.background = '#fafafa';
}

// Handle image drop
function handleImageDrop(e, slotNumber) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.style.borderColor = '#ccc';
    e.currentTarget.style.background = '#fafafa';

    const file = e.dataTransfer.files[0];
    if (!file) return;

    uploadImageFile(file, slotNumber);
}

// Handle single image upload
function handleSingleImageUpload(event, slotNumber) {
    const file = event.target.files[0];
    if (!file) return;

    uploadImageFile(file, slotNumber);
}

// Upload image file
async function uploadImageFile(file, slotNumber) {
    if (!currentPropertyId) {
        alert('Please save the property first before uploading images.');
        return;
    }

    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('Invalid file type. Only JPG, PNG, GIF, or WebP allowed.');
        return;
    }

    // Show loading state
    const preview = document.getElementById(`preview-${slotNumber}`);
    preview.innerHTML = '<div style="color: #666; font-size: 12px;">Uploading...</div>';

    // Create FormData
    const formData = new FormData();
    formData.append('image_file', file);
    formData.append('property_id', currentPropertyId);

    try {
        const response = await fetch('{% url "add_property" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            // Store uploaded image data
            uploadedImages.push({
                id: data.image_id,
                url: data.image_url,
                order: data.order,
                slot: slotNumber
            });

            // Show image preview
            preview.innerHTML = `
                <img src="${data.image_url}" alt="Property image" style="width: 100%; height: 100%; object-fit: cover;">
                <button type="button" class="btn-remove" onclick="deleteImage(${data.image_id}, ${slotNumber})" style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 10px; cursor: pointer; font-weight: 600;">Remove</button>
            `;

            // Update filename
            document.getElementById(`filename-${slotNumber}`).textContent = file.name;

            // Update slot styling
            const slot = document.getElementById(`image-slot-${slotNumber}`);
            slot.classList.remove('empty');
            slot.classList.add('filled');

        } else {
            preview.innerHTML = '<div class="image-placeholder">ðŸ“·<br>Click or Drag</div>';
            alert('Upload failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        preview.innerHTML = '<div class="image-placeholder">ðŸ“·<br>Click or Drag</div>';
        console.error('Upload error:', error);
        alert('Error uploading image. Please try again.');
    }
}

// Delete image
async function deleteImage(imageId, slotNumber) {
    if (!confirm('Remove this image?')) return;

    try {
        const response = await fetch(`/SE/PD/property/${currentPropertyId}/images/delete/${imageId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.success) {
            // Remove from uploadedImages array
            uploadedImages = uploadedImages.filter(img => img.id !== imageId);

            // Reset the slot
            const preview = document.getElementById(`preview-${slotNumber}`);
            preview.innerHTML = '<div class="image-placeholder">ðŸ“·<br>Click or Drag</div>';

            const filename = document.getElementById(`filename-${slotNumber}`);
            filename.textContent = '';

            const slot = document.getElementById(`image-slot-${slotNumber}`);
            slot.classList.remove('filled');
            slot.classList.add('empty');

            alert('Image removed successfully!');
        } else {
            alert('Failed to delete image.');
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert('Error deleting image. Please try again.');
    }
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Tab switching function
function switchTab(tabName, event) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

// ============================================
// REAL-TIME FORMATTING FUNCTIONS
// ============================================

function formatPhone(input) {
    // Get cursor position before formatting
    let cursorPos = input.selectionStart;
    let oldValue = input.value;

    // Remove all non-digits
    let value = input.value.replace(/\D/g, '');
    value = value.substring(0, 10);

    let formatted = '';
    if (value.length >= 6) {
        formatted = '(' + value.substring(0,3) + ') ' + value.substring(3,6) + '-' + value.substring(6);
    } else if (value.length >= 3) {
        formatted = '(' + value.substring(0,3) + ') ' + value.substring(3);
    } else if (value.length > 0) {
        formatted = '(' + value;
    }

    input.value = formatted;

    // Calculate new cursor position
    if (cursorPos === oldValue.length) {
        // If cursor was at end, keep it at end
        input.setSelectionRange(formatted.length, formatted.length);
    } else {
        // Count digits before cursor in old value
        let digitsBeforeCursor = oldValue.substring(0, cursorPos).replace(/\D/g, '').length;

        // Find position of nth digit in new formatted value
        let newCursorPos = 0;
        let digitCount = 0;
        for (let i = 0; i < formatted.length; i++) {
            if (/\d/.test(formatted[i])) {
                digitCount++;
                if (digitCount === digitsBeforeCursor) {
                    newCursorPos = i + 1;
                    break;
                }
            }
        }

        if (digitCount < digitsBeforeCursor) {
            newCursorPos = formatted.length;
        }

        input.setSelectionRange(newCursorPos, newCursorPos);
    }
}

function formatNumber(input) {
    // Get cursor position
    let cursorPos = input.selectionStart;
    let oldValue = input.value;

    // Remove existing commas
    let value = input.value.replace(/,/g, '');

    // Only format if it's a valid number
    if (!isNaN(value) && value !== '') {
        let formatted = Number(value).toLocaleString('en-US');
        input.value = formatted;

        // Calculate new cursor position
        if (cursorPos === oldValue.length) {
            // If cursor was at end, keep it at end
            input.setSelectionRange(formatted.length, formatted.length);
        } else {
            // Count digits before cursor
            let digitsBeforeCursor = oldValue.substring(0, cursorPos).replace(/\D/g, '').length;

            // Find position after nth digit in formatted value
            let newCursorPos = 0;
            let digitCount = 0;
            for (let i = 0; i < formatted.length; i++) {
                if (/\d/.test(formatted[i])) {
                    digitCount++;
                    if (digitCount === digitsBeforeCursor) {
                        newCursorPos = i + 1;
                        break;
                    }
                }
            }

            if (digitCount < digitsBeforeCursor) {
                newCursorPos = formatted.length;
            }

            input.setSelectionRange(newCursorPos, newCursorPos);
        }
    }
}

function formatCurrency(input) {
    // Get cursor position
    let cursorPos = input.selectionStart;
    let oldValue = input.value;

    // Remove $ and commas
    let value = input.value.replace(/[$,]/g, '');

    // Only format if it's a valid number
    if (!isNaN(value) && value !== '') {
        let formatted = '$' + Number(value).toLocaleString('en-US');
        input.value = formatted;

        // Calculate new cursor position
        if (cursorPos === oldValue.length) {
            // If cursor was at end, keep it at end
            input.setSelectionRange(formatted.length, formatted.length);
        } else {
            // Count digits before cursor
            let charsBeforeCursor = oldValue.substring(0, cursorPos);
            let digitsBeforeCursor = charsBeforeCursor.replace(/\D/g, '').length;

            // Find position after nth digit in formatted value (skip the $)
            let newCursorPos = 1; // Start after $
            let digitCount = 0;
            for (let i = 1; i < formatted.length; i++) {
                if (/\d/.test(formatted[i])) {
                    digitCount++;
                    if (digitCount === digitsBeforeCursor) {
                        newCursorPos = i + 1;
                        break;
                    }
                }
            }

            if (digitCount < digitsBeforeCursor) {
                newCursorPos = formatted.length;
            }

            input.setSelectionRange(newCursorPos, newCursorPos);
        }
    } else if (value === '') {
        input.value = '';
    }
}

function formatDecimal(input, decimals = 2) {
    // Get cursor position
    let cursorPos = input.selectionStart;
    let value = input.value.replace(/,/g, '');

    // Allow decimal input
    if (!isNaN(value) && value !== '') {
        // Don't format if user is typing decimal
        if (value.endsWith('.')) {
            return;
        }

        let parts = value.split('.');
        parts[0] = Number(parts[0]).toLocaleString('en-US');

        if (parts.length > 1) {
            parts[1] = parts[1].substring(0, decimals);
            input.value = parts.join('.');
        } else {
            input.value = parts[0];
        }
    }
}

function formatPercentage(input, decimals = 2) {
    let cursorPos = input.selectionStart;
    let value = input.value.replace(/[%,]/g, '');

    if (!isNaN(value) && value !== '') {
        // Don't format if user is typing decimal
        if (value.endsWith('.')) {
            return;
        }

        let formatted = value;
        if (value.includes('.')) {
            let parts = value.split('.');
            parts[1] = parts[1].substring(0, decimals);
            formatted = parts.join('.');
        }

        input.value = formatted + '%';

        // Keep cursor before the %
        if (cursorPos >= input.value.length - 1) {
            input.setSelectionRange(input.value.length - 1, input.value.length - 1);
        }
    }
}

// ============================================
// AUTO-ATTACH FORMATTERS
// ============================================

document.addEventListener('DOMContentLoaded', function() {

    // Phone number fields
    const phoneFields = document.querySelectorAll('input[type="tel"], input[name*="phone"], input[id*="phone"]');
    phoneFields.forEach(input => {
        input.addEventListener('input', function() {
            formatPhone(this);
        });
    });

    // Currency fields (with $ symbol)
    const currencyFields = document.querySelectorAll(
        'input[name*="price"], input[name*="amount"], input[name*="cost"], ' +
        'input[name*="equity"], input[name*="debt"], input[name*="noi"], ' +
        'input[name*="flow"], input[id*="price"], input[id*="amount"]'
    );
    currencyFields.forEach(input => {
        // Skip percentage fields
        if (!input.name.includes('percent') && !input.name.includes('rate') &&
            !input.id.includes('percent') && !input.id.includes('rate')) {

            input.addEventListener('input', function() {
                formatCurrency(this);
            });

            // Format on load if value exists
            if (input.value) {
                formatCurrency(input);
            }
        }
    });

    // Percentage fields
    const percentFields = document.querySelectorAll(
        'input[name*="percent"], input[name*="rate"], input[name*="_pct"], ' +
        'input[id*="percent"], input[id*="rate"]'
    );
    percentFields.forEach(input => {
        input.addEventListener('input', function() {
            formatPercentage(this);
        });

        // Format on load if value exists
        if (input.value && !input.value.includes('%')) {
            formatPercentage(input);
        }
    });

    // Number fields (no $, just commas)
    const numberFields = document.querySelectorAll(
        'input[name*="_sf"], input[name*="units"], input[name*="tenants"], ' +
        'input[id*="_sf"], input[id*="units"]'
    );
    numberFields.forEach(input => {
        input.addEventListener('input', function() {
            formatNumber(this);
        });

        // Format on load if value exists
        if (input.value) {
            formatNumber(input);
        }
    });

    // Decimal fields (e.g., acres, WALT)
    const decimalFields = document.querySelectorAll(
        'input[name*="acres"], input[name*="walt"], input[name*="dscr"]'
    );
    decimalFields.forEach(input => {
        input.addEventListener('input', function() {
            formatDecimal(this);
        });

        // Format on load if value exists
        if (input.value) {
            formatDecimal(input);
        }
    });
});

// ============================================
// FORM SUBMISSION - CLEAN VALUES
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');

    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            // Clean all formatted inputs before submission
            const inputs = this.querySelectorAll('input[type="text"], input[type="tel"]');

            inputs.forEach(input => {
                // Remove formatting characters but keep decimals and negatives
                input.value = input.value.replace(/[$,()%\s-]/g, '');
            });
        });
    });
});

// ============================================
// MANUAL FORMAT FUNCTIONS (for specific fields)
// ============================================

// Call these on specific inputs if needed
function applyPhoneFormat(selector) {
    const input = document.querySelector(selector);
    if (input) {
        input.addEventListener('input', function() {
            formatPhone(this);
        });
        if (input.value) formatPhone(input);
    }
}

function applyCurrencyFormat(selector) {
    const input = document.querySelector(selector);
    if (input) {
        input.addEventListener('input', function() {
            formatCurrency(this);
        });
        if (input.value) formatCurrency(input);
    }
}

function applyPercentFormat(selector) {
    const input = document.querySelector(selector);
    if (input) {
        input.addEventListener('input', function() {
            formatPercentage(this);
        });
        if (input.value) formatPercentage(input);
    }
}

function updateKBIOptions() {
    const kbi1 = document.getElementById('kbi1').value;
    const kbi2 = document.getElementById('kbi2').value;
    const kbi3 = document.getElementById('kbi3').value;
    const kbi4 = document.getElementById('kbi4').value;
    const selected = [kbi1, kbi2, kbi3, kbi4].filter(v => v);
    ['kbi1', 'kbi2', 'kbi3', 'kbi4'].forEach(id => {
        const select = document.getElementById(id);
        const currentValue = select.value;
        Array.from(select.options).forEach(option => {
            if (option.value && selected.includes(option.value) && option.value !== currentValue) {
                option.style.color = '#ccc';
                option.style.fontStyle = 'italic';
            } else if (option.value) {
                option.style.color = '';
                option.style.fontStyle = '';
            }
        });
    });
}

function updateRefNum() {
    const assetClass = document.getElementById('assetClass').value;
    if (!assetClass) return;
    const propertyTypes = {
        'SB': 'Small Bay / Flex',
        'IN': 'Industrial',
        'MF': 'Multi-Family',
        'OF': 'Office',
        'RT': 'Retail',
        'HT': 'Hotel',
        'MA': 'Marina',
        'SS': 'Self Storage',
        'MS': 'Misc.'
    };
    document.getElementById('propertyType').value = propertyTypes[assetClass];
}

async function fillSubmarket() {
    const city = document.getElementById('city').value;
    const state = document.getElementById('state').value;
    if (city && state) {
        document.getElementById('submarket').value = `${city}, ${state}`;
    }
}

function updateMarketingTitleDisplay() {
    const title = document.getElementById('marketingTitle').value;
    document.getElementById('marketingTitleDisplay').textContent = title || 'Not Set';
    document.getElementById('title').value = title;
}

function generateHeroSummary() {
    const sf = document.getElementById('sf').value;
    const assetClass = document.getElementById('assetClass').value;
    const address = document.getElementById('address').value;
    const city = document.getElementById('city').value;
    const state = document.getElementById('state').value;
    const purchasePrice = document.getElementById('purchasePrice').value;
    const noi = document.getElementById('noi').value;
    const occupancy = document.getElementById('occupancy').value;
    const walt = document.getElementById('walt').value;
    const kbi1 = document.getElementById('kbi1').value;
    if (!assetClass || !city || !state) {
        alert('Please fill in at least Asset Class, City, and State first');
        return;
    }
    const assetNames = {
        'SB': 'Small Bay/Flex', 'IN': 'Industrial', 'MF': 'Multi-Family',
        'OF': 'Office', 'RT': 'Retail', 'HT': 'Hospitality',
        'MA': 'Marina', 'SS': 'Self-Storage', 'MS': 'Medical/Senior'
    };
    let summary = '';
    if (sf) summary += `${sf.replace(/,/g, '')} SF `;
    summary += `${assetNames[assetClass] || assetClass} property`;
    if (city && state) summary += ` in ${city}, ${state}`;
    if (purchasePrice) summary += `. Priced at ${purchasePrice}`;
    if (noi) summary += `. Generating ${noi} NOI`;
    if (occupancy) summary += `. ${occupancy} occupied`;
    if (walt) summary += ` with ${walt} year WALT`;
    if (kbi1) summary += `. Value-add opportunity: ${kbi1.toLowerCase()}`;
    summary += '. Prime investment opportunity.';
    document.getElementById('heroSummary').value = summary;
    alert('Hero Summary generated successfully!');
}

async function showAISuggest() {
    const address = document.getElementById('address').value;
    const city = document.getElementById('city').value;
    const state = document.getElementById('state').value;
    const assetClass = document.getElementById('assetClass').value;
    if (!address || !city || !state || !assetClass) {
        alert('Please fill in Address, City, State, and Asset Class first.');
        return;
    }
    const terrain = await getTerrainData(address, city, state);
    const { part1, part2, topSuggestions } = generateSmartSuggestions(address, city, state, assetClass, terrain);
    const part1Container = document.getElementById('part1Options');
    part1Container.innerHTML = '';
    part1.forEach(desc => {
        const div = document.createElement('div');
        div.className = 'ai-option';
        div.textContent = desc;
        div.onclick = () => selectPart1(desc, div);
        part1Container.appendChild(div);
    });
    const part2Container = document.getElementById('part2Options');
    part2Container.innerHTML = '';
    part2.forEach(name => {
        const div = document.createElement('div');
        div.className = 'ai-option';
        div.textContent = name;
        div.onclick = () => selectPart2(name, div);
        part2Container.appendChild(div);
    });
    const topSuggestionsContainer = document.getElementById('topSuggestionsList');
    topSuggestionsContainer.innerHTML = '';
    topSuggestions.forEach(suggestion => {
        const div = document.createElement('div');
        div.className = 'top-suggestion-item';
        div.textContent = suggestion;
        div.onclick = () => selectTopSuggestion(suggestion, div);
        topSuggestionsContainer.appendChild(div);
    });
    document.getElementById('aiModal').classList.add('active');
}

function selectPart1(descriptor, element) {
    document.querySelectorAll('#part1Options .ai-option').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    selectedPart1 = descriptor;
    selectedTopSuggestion = '';
    document.querySelectorAll('.top-suggestion-item').forEach(el => el.classList.remove('selected'));
    updateCombinedPreview();
}

function selectPart2(name, element) {
    document.querySelectorAll('#part2Options .ai-option').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    selectedPart2 = name;
    selectedTopSuggestion = '';
    document.querySelectorAll('.top-suggestion-item').forEach(el => el.classList.remove('selected'));
    updateCombinedPreview();
}

function selectTopSuggestion(suggestion, element) {
    document.querySelectorAll('.top-suggestion-item').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    selectedTopSuggestion = suggestion;
    selectedPart1 = '';
    selectedPart2 = '';
    document.querySelectorAll('#part1Options .ai-option').forEach(el => el.classList.remove('selected'));
    document.querySelectorAll('#part2Options .ai-option').forEach(el => el.classList.remove('selected'));
    document.getElementById('combinedPreview').textContent = suggestion;
    document.getElementById('useNameBtn').disabled = false;
}

function updateCombinedPreview() {
    const preview = document.getElementById('combinedPreview');
    const useBtn = document.getElementById('useNameBtn');
    if (selectedPart1 && selectedPart2) {
        preview.textContent = `${selectedPart1} ${selectedPart2}`;
        useBtn.disabled = false;
    } else if (selectedPart1 || selectedPart2) {
        preview.textContent = selectedPart1 || selectedPart2;
        useBtn.disabled = true;
    } else {
        preview.textContent = 'Select from Part 1 and Part 2';
        useBtn.disabled = true;
    }
}

function useSelectedName() {
    let finalName = '';
    if (selectedTopSuggestion) {
        finalName = selectedTopSuggestion;
    } else if (selectedPart1 && selectedPart2) {
        finalName = `${selectedPart1} ${selectedPart2}`;
    }
    if (finalName) {
        const city = document.getElementById('city').value.trim();
        const state = document.getElementById('state').value.trim();
        if (city && state) {
            finalName = `${finalName} - ${city}, ${state}`;
        }
        const titleField = document.getElementById('marketingTitle');
        titleField.value = finalName;
        titleField.classList.add('ai-generated');
        document.getElementById('marketingTitleDisplay').textContent = finalName;
        document.getElementById('title').value = finalName;
        closeAIModal();
        updateProgress();
    }
}

function closeAIModal() {
    document.getElementById('aiModal').classList.remove('active');
    selectedPart1 = '';
    selectedPart2 = '';
    selectedTopSuggestion = '';
}

async function getTerrainData(address, city, state) {
    try {
        const geocoder = new google.maps.Geocoder();
        const fullAddress = `${address}, ${city}, ${state}`;
        const geocodeResult = await new Promise((resolve, reject) => {
            geocoder.geocode({ address: fullAddress }, (results, status) => {
                if (status === 'OK') resolve(results[0]);
                else reject(status);
            });
        });
        const location = geocodeResult.geometry.location;
        const addressComponents = geocodeResult.address_components;
        let submarket = '';
        addressComponents.forEach(component => {
            if (component.types.includes('locality')) {
                submarket = component.long_name;
            }
            if (component.types.includes('administrative_area_level_2')) {
                submarket += submarket ? `, ${component.long_name}` : component.long_name;
            }
        });
        document.getElementById('submarket').value = submarket;
        const elevator = new google.maps.ElevationService();
        const elevationResult = await new Promise((resolve, reject) => {
            elevator.getElevationForLocations({ locations: [location] }, (results, status) => {
                if (status === 'OK') resolve(results[0]);
                else reject(status);
            });
        });
        const elevation = elevationResult.elevation;
        const coastalStates = ['CA', 'FL', 'NY', 'NJ', 'MA', 'CT', 'RI', 'MD', 'VA', 'NC', 'SC', 'GA', 'TX', 'LA', 'MS', 'AL', 'WA', 'OR'];
        const isCoastalState = coastalStates.includes(state.toUpperCase());
        const isInland = (city.toLowerCase() === 'hauppauge' && state.toUpperCase() === 'NY');
        if (isInland || (!isCoastalState && elevation < 100)) {
            return 'urban';
        } else if (isCoastalState && elevation < 100 && !isInland) {
            return 'coastal';
        } else if (elevation >= 500 && elevation < 1500) {
            return 'hilly';
        } else if (elevation >= 1500) {
            return 'mountain';
        } else {
            return 'urban';
        }
    } catch (error) {
        console.error('Terrain detection error:', error);
        return 'urban';
    }
}

function generateSmartSuggestions(address, city, state, assetClass, terrain) {
    const streetName = address.split(' ').slice(1).join(' ').split(',')[0];
    const terrainDescriptors = {
        'coastal': ['Harbor', 'Bay', 'Coastal', 'Waterfront', 'Seaside', 'Point', 'Landing', 'Pier'],
        'hilly': ['Ridge', 'Hill', 'Terrace', 'Crest', 'Heights', 'Vista', 'Overlook', 'Summit'],
        'mountain': ['Ridge', 'Peak', 'Summit', 'Alpine', 'Highland', 'Grove', 'Canyon', 'Crest'],
        'urban': ['Metro', 'City', 'Urban', 'Downtown', 'District', 'Plaza', 'Square', 'Central']
    };
    const genericDescriptors = ['Axis', 'Apex', 'Main', 'Central', 'Premier', 'Elite', 'Summit', 'Gateway', 'Meridian', 'Atlas'];
    let part1 = [...(terrainDescriptors[terrain] || terrainDescriptors['urban']), ...genericDescriptors];
    if (streetName && streetName.length < 15) part1.unshift(streetName);
    if (city && city.length < 15) part1.unshift(city);
    const nounsByClass = {
        'SB': ['Business Park', 'Flex Center', 'Commerce Park', 'Industrial Center', 'Trade Hub', 'Works', 'Campus', 'Complex'],
        'IN': ['Logistics Park', 'Distribution Center', 'Industrial Park', 'Commerce Hub', 'Trade Center', 'Warehouse Park', 'Works', 'Exchange'],
        'MF': ['Residences', 'Apartments', 'Lofts', 'Commons', 'Flats', 'Pointe', 'Reserve', 'Homes'],
        'OF': ['Office Center', 'Business Center', 'Corporate Plaza', 'Professional Center', 'Tower', 'Works', 'Hub', 'Collective'],
        'RT': ['Shopping Center', 'Retail Plaza', 'Market', 'Marketplace', 'Walk', 'Village', 'Promenade', 'Crossing'],
        'HT': ['Hotel', 'Inn', 'Suites', 'Resort', 'Lodge', 'Hospitality Center', 'Retreat', 'Grand Hotel'],
        'MA': ['Marina', 'Yacht Club', 'Docks', 'Boat Club', 'Sailing Club', 'Anchorage', 'Moorings', 'Quay'],
        'SS': ['Storage', 'Self Storage', 'Storage Center', 'Vault', 'Storage Park', 'Secure Storage', 'Lock & Store', 'Storage Depot'],
        'MS': ['Center', 'Plaza', 'Complex', 'Park', 'Place', 'Facility', 'Property', 'Development']
    };
    const part2 = nounsByClass[assetClass] || nounsByClass['MS'];
    const topSuggestions = [];
    const shuffledPart1 = [...part1].sort(() => Math.random() - 0.5);
    const shuffledPart2 = [...part2].sort(() => Math.random() - 0.5);
    for (let i = 0; i < 5 && topSuggestions.length < 5; i++) {
        const suggestion = `${shuffledPart1[i % shuffledPart1.length]} ${shuffledPart2[i % shuffledPart2.length]}`;
        if (!topSuggestions.includes(suggestion)) {
            topSuggestions.push(suggestion);
        }
    }
    return { part1, part2, topSuggestions };
}

function calcAll() {
    // Get values and strip formatting
    const purchasePrice = parseFloat(document.getElementById('purchasePrice').value.replace(/[$,]/g, '')) || 0;
    const ltv = parseFloat(document.getElementById('ltv').value.replace(/[%,]/g, '')) || 0;
    const noi = parseFloat(document.getElementById('noi').value.replace(/[$,]/g, '')) || 0;

    // Calculate Debt = Purchase Price Ã— (LTV / 100)
    const debt = purchasePrice * (ltv / 100);

    // Calculate Equity = Purchase Price - Debt
    const equity = purchasePrice - debt;

    // Calculate Cap Rate = (NOI / Purchase Price) Ã— 100
    const capRate = purchasePrice > 0 ? (noi / purchasePrice) * 100 : 0;

    // Update Debt field (show value even if $0)
    if (purchasePrice > 0) {
        document.getElementById('debt').value = '$' + debt.toLocaleString('en-US', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    } else {
        document.getElementById('debt').value = '';
    }

    // Update Equity field (show value even if equals full purchase price)
    if (purchasePrice > 0) {
        document.getElementById('totalEquity').value = '$' + equity.toLocaleString('en-US', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    } else {
        document.getElementById('totalEquity').value = '';
    }

    // Update Cap Rate
    if (capRate > 0) {
        document.getElementById('capRate').value = capRate.toFixed(2) + '%';
    } else {
        document.getElementById('capRate').value = '';
    }
}

function calcCashOnCash() {
    const annualCashFlow = parseFloat(document.getElementById('estAnnualCashFlow').value.replace(/[$,]/g, '')) || 0;
    const totalEquity = parseFloat(document.getElementById('totalEquity').value.replace(/[$,]/g, '')) || 0;

    if (annualCashFlow && totalEquity && totalEquity > 0) {
        // Cash on Cash = (Annual Cash Flow / Total Equity) Ã— 100
        const cashOnCash = (annualCashFlow / totalEquity * 100).toFixed(2);
        document.getElementById('estCashOnCash').value = cashOnCash + '%';

        // Per $100k = (Cash on Cash / 100) Ã— $100,000
        const per100k = (parseFloat(cashOnCash) / 100 * 100000).toFixed(0);
        document.getElementById('per100k').value = '$' + Number(per100k).toLocaleString();
    } else {
        document.getElementById('estCashOnCash').value = '';
        document.getElementById('per100k').value = '';
    }
}

function calcTenantPct(tenantNum) {
    const buildingSF = parseFloat(document.getElementById('sf').value.replace(/[^0-9.]/g, '')) || 0;
    const tenantSF = parseFloat(document.getElementById(`tenant${tenantNum}SF`).value.replace(/[^0-9.]/g, '')) || 0;

    if (buildingSF && buildingSF > 0 && tenantSF) {
        // Tenant % = (Tenant SF / Building SF) Ã— 100
        const pct = (tenantSF / buildingSF * 100).toFixed(1);
        document.getElementById(`tenant${tenantNum}Pct`).value = pct + '%';
    } else {
        document.getElementById(`tenant${tenantNum}Pct`).value = '';
    }
}

// Helper function for percentage formatting
function formatPercentage(input) {
    let value = input.value.replace(/[%,]/g, '');

    if (!isNaN(value) && value !== '') {
        // Don't format if user is typing decimal
        if (value.endsWith('.')) {
            return;
        }

        let formatted = value;
        if (value.includes('.')) {
            let parts = value.split('.');
            parts[1] = parts[1].substring(0, 2);
            formatted = parts.join('.');
        }

        input.value = formatted + '%';
    }
}

function updateProgress() {
    // Full required set for draft completeness (visual progress only)
    const requiredFields = [
        'assetClass', 'dealStatus', 'loiDate',
        'address', 'city', 'state', 'zip', 'sf', 'acres', 'locationHighlights',
        'purchasePrice', 'ltv', 'noi', 'irr',
        'kbi1', 'businessPlan', 'heroSummary',
        'estAnnualCashFlow',
        'numTenants', 'occupancy', 'walt',
        'tenant1Name', 'tenant1SF', 'tenant1Expiry', 'tenant1LeaseStructure', 'tenant1Guarantee',
        'brokerName', 'brokerCompany', 'brokerCell', 'brokerEmail', 'commission'
    ];

    let filled = 0;
    let totalRequired = requiredFields.length;

    // Check base required fields
    requiredFields.forEach(id => {
        const field = document.getElementById(id);
        if (field && field.value && field.value.trim() !== '') {
            if (field.tagName === 'SELECT') {
                if (field.value !== '' &&
                    field.value !== 'Select...' &&
                    field.value !== 'Deal Status...') {
                    filled++;
                }
            } else {
                filled++;
            }
        }
    });

    // Check if Tenant 2 row is filled - if so, add those fields to required count
    const tenant2Name = document.getElementById('tenant2Name').value.trim();
    if (tenant2Name) {
        totalRequired += 3; // Add SF, Expiry, Guarantee
        if (tenant2Name) filled++; // Count the name field

        const tenant2SF = document.getElementById('tenant2SF').value.replace(/[,]/g, '');
        if (tenant2SF && parseFloat(tenant2SF) > 0) filled++;

        const tenant2Expiry = document.getElementById('tenant2Expiry').value;
        if (tenant2Expiry) filled++;

        const tenant2Guarantee = document.getElementById('tenant2Guarantee').value;
        if (tenant2Guarantee) filled++;
    }

    // Check if Tenant 3 row is filled - if so, add those fields to required count
    const tenant3Name = document.getElementById('tenant3Name').value.trim();
    if (tenant3Name) {
        totalRequired += 3; // Add SF, Expiry, Guarantee
        if (tenant3Name) filled++; // Count the name field

        const tenant3SF = document.getElementById('tenant3SF').value.replace(/[,]/g, '');
        if (tenant3SF && parseFloat(tenant3SF) > 0) filled++;

        const tenant3Expiry = document.getElementById('tenant3Expiry').value;
        if (tenant3Expiry) filled++;

        const tenant3Guarantee = document.getElementById('tenant3Guarantee').value;
        if (tenant3Guarantee) filled++;
    }

    const percentage = Math.round((filled / totalRequired) * 100);
    document.getElementById('progressPercent').textContent = percentage;
}
function attachProgressListeners() {
    const requiredFields = [
        'assetClass', 'dealStatus', 'loiDate',
        'address', 'city', 'state', 'zip', 'sf', 'acres', 'locationHighlights',
        'purchasePrice', 'ltv', 'noi', 'irr',
        'kbi1', 'businessPlan', 'heroSummary',
        'estAnnualCashFlow',
        'numTenants', 'occupancy', 'walt',
        'tenant1Name', 'tenant1SF', 'tenant1Expiry', 'tenant1LeaseStructure', 'tenant1Guarantee',
        'tenant2Name', 'tenant2SF', 'tenant2Expiry', 'tenant2Guarantee',
        'tenant3Name', 'tenant3SF', 'tenant3Expiry', 'tenant3Guarantee',
        'brokerName', 'brokerCompany', 'brokerCell', 'brokerEmail', 'commission'
    ];

    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
                field.addEventListener('input', updateProgress);
                field.addEventListener('change', updateProgress);
            } else if (field.tagName === 'SELECT') {
                field.addEventListener('change', updateProgress);
            }
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Add Property Form Initialized');
    updateProgress();
    initializeImageGrid();
    attachProgressListeners(); // ADD THIS LINE

    // AUTO-SELECT PSA +20 and DD END +45
    const loiDateInput = document.getElementById('loiDate');

    loiDateInput.addEventListener('change', function() {
        if (this.value) {
            setTimeout(() => {
                addDaysTo('loiDate', 'psaDate', 20);
                setTimeout(() => {
                    addDaysTo('psaDate', 'ddEnd', 45);
                }, 200);
            }, 100);
        }
    });

    const psaDateInput = document.getElementById('psaDate');
    psaDateInput.addEventListener('change', function() {
        if (this.value) {
            setTimeout(() => {
                addDaysTo('psaDate', 'ddEnd', 45);
            }, 100);
        }
    });
});
const documentStorage = {
    om: [], rentroll: [], proforma: [], tic: [], environmental: [],
    legal: [], operating: [], market: [], brochure: [], other: []
};

function uploadDoc(type) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf,.doc,.docx,.xls,.xlsx';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            if (!documentStorage[type]) documentStorage[type] = [];
            documentStorage[type].push(file);
            updateDocDisplay(type);
        }
    };
    input.click();
}

function handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.style.background = '#e8f5e9';
    event.currentTarget.style.borderColor = '#22c55e';
}

function handleDrop(event, type) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.style.background = '';
    event.currentTarget.style.borderColor = '';
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (!documentStorage[type]) documentStorage[type] = [];
        documentStorage[type].push(file);
        updateDocDisplay(type);
    }
}

function updateDocDisplay(type) {
    const boxes = document.querySelectorAll('.doc-box');
    let targetBox = null;
    boxes.forEach(box => {
        const onclick = box.getAttribute('onclick');
        if (onclick && onclick.includes(`'${type}'`)) {
            targetBox = box;
        }
    });
    if (!targetBox) return;
    const files = documentStorage[type] || [];
    const existingList = targetBox.querySelector('.doc-file-list');
    if (existingList) existingList.remove();
    if (files.length > 0) {
        const fileList = document.createElement('div');
        fileList.className = 'doc-file-list';
        fileList.style.cssText = 'margin-top: 0.5rem; font-size: 10px;';
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.2rem; background: #f0f0f0; border-radius: 3px; margin-bottom: 0.2rem;';

            // Check if this is an existing file (has URL) or a newly uploaded file
            if (file.existing && file.url) {
                // Existing file - show download button
                fileItem.innerHTML = `
                    <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</span>
                    <div style="display: flex; gap: 0.2rem;">
                        <a href="${file.url}" download="${file.name}" onclick="event.stopPropagation();" style="background: #2196F3; color: white; border: none; border-radius: 3px; padding: 0.1rem 0.3rem; cursor: pointer; font-size: 10px; text-decoration: none; display: inline-block;">â†“</a>
                        <button onclick="removeDocFile('${type}', ${index}); event.stopPropagation();" style="background: #ff4444; color: white; border: none; border-radius: 3px; padding: 0.1rem 0.3rem; cursor: pointer; font-size: 10px;">Ã—</button>
                    </div>
                `;
            } else {
                // Newly uploaded file (not yet saved) - no download button
                fileItem.innerHTML = `
                    <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</span>
                    <button onclick="removeDocFile('${type}', ${index}); event.stopPropagation();" style="background: #ff4444; color: white; border: none; border-radius: 3px; padding: 0.1rem 0.3rem; cursor: pointer; font-size: 10px;">Ã—</button>
                `;
            }

            fileList.appendChild(fileItem);
        });
        targetBox.appendChild(fileList);
        targetBox.style.background = '#f0f9ff';
    } else {
        targetBox.style.background = '';
    }
}

function removeDocFile(type, index) {
    if (documentStorage[type]) {
        documentStorage[type].splice(index, 1);
        updateDocDisplay(type);
    }
}

function validateRequiredFields() {
    const errors = [];

    const getVal = (id) => {
        const el = document.getElementById(id);
        if (!el) return '';
        return el.value.trim();
    };

    // Asset / Deal
    if (!getVal('assetClass')) errors.push('Asset Class');
    const dealStatus = getVal('dealStatus');
    if (!dealStatus || dealStatus === 'Deal Status...') errors.push('Deal Status');
    if (!getVal('loiDate')) errors.push('LOI Date');

    // Location
    if (!getVal('address')) errors.push('Address');
    if (!getVal('city')) errors.push('City');
    if (!getVal('state')) errors.push('State');
    if (!getVal('zip')) errors.push('ZIP Code');
    if (!getVal('sf')) errors.push('Square Feet');
    if (!getVal('acres')) errors.push('Acres');
    if (!getVal('locationHighlights')) errors.push('Location Highlights');

    // Financials
    const purchasePriceRaw = getVal('purchasePrice').replace(/[$,]/g,'');
    if (!purchasePriceRaw || parseFloat(purchasePriceRaw) <= 0) errors.push('Acquisition Price');

    const ltvRaw = getVal('ltv').replace(/[%,]/g,'');
    if (ltvRaw === '' || isNaN(parseFloat(ltvRaw)) || parseFloat(ltvRaw) < 0 || parseFloat(ltvRaw) > 100) errors.push('LTV % (0-100)');

    const noiRaw = getVal('noi').replace(/[$,]/g,'');
    if (!noiRaw || parseFloat(noiRaw) <= 0) errors.push('NOI');

    const irrRaw = getVal('irr').replace(/[%,]/g,'');
    if (!irrRaw || parseFloat(irrRaw) <= 0) errors.push('IRR (5yr)');

    // KBIs & Plan
    if (!getVal('kbi1')) errors.push('Key Business Initiative #1');
    if (!getVal('businessPlan')) errors.push('Business Plan');
    if (!getVal('heroSummary')) errors.push('Hero Summary');

    // Distribution
    const distRaw = getVal('estAnnualCashFlow').replace(/[$,]/g,'');
    if (!distRaw || parseFloat(distRaw) <= 0) errors.push('Distribution (Annual Cash Flow)');

    // Tenancy
    if (!getVal('numTenants')) errors.push('Number of Tenants');
    if (!getVal('occupancy')) errors.push('Occupancy %');
    if (!getVal('walt')) errors.push('WALT (years)');

    // Tenant 1 mandatory
    if (!getVal('tenant1Name')) errors.push('Top Tenant 1 Name');
    const t1sfRaw = getVal('tenant1SF').replace(/[,]/g,'');
    if (!t1sfRaw || parseFloat(t1sfRaw) <= 0) errors.push('Top Tenant 1 SF Leased');
    if (!getVal('tenant1Expiry')) errors.push('Top Tenant 1 Lease Expiry Date');
    if (!getVal('tenant1LeaseStructure')) errors.push('Top Tenant 1 Lease Structure');
    if (!getVal('tenant1Guarantee')) errors.push('Top Tenant 1 Corp/Personal Guarantee');

    // Conditional tenants
    const t2name = getVal('tenant2Name');
    if (t2name) {
        const t2sf = getVal('tenant2SF').replace(/[,]/g,'');
        if (!t2sf || parseFloat(t2sf) <= 0) errors.push('Top Tenant 2 SF Leased');
        if (!getVal('tenant2Expiry')) errors.push('Top Tenant 2 Lease Expiry Date');
        if (!getVal('tenant2LeaseStructure')) errors.push('Top Tenant 2 Lease Structure');
        if (!getVal('tenant2Guarantee')) errors.push('Top Tenant 2 Corp/Personal Guarantee');
    }
    const t3name = getVal('tenant3Name');
    if (t3name) {
        const t3sf = getVal('tenant3SF').replace(/[,]/g,'');
        if (!t3sf || parseFloat(t3sf) <= 0) errors.push('Top Tenant 3 SF Leased');
        if (!getVal('tenant3Expiry')) errors.push('Top Tenant 3 Lease Expiry Date');
        if (!getVal('tenant3LeaseStructure')) errors.push('Top Tenant 3 Lease Structure');
        if (!getVal('tenant3Guarantee')) errors.push('Top Tenant 3 Corp/Personal Guarantee');
    }

    // Broker
    if (!getVal('brokerName')) errors.push('Broker Name');
    if (!getVal('brokerCompany')) errors.push('Broker Company Name');
    if (!getVal('brokerCell')) errors.push('Broker Cell');
    if (!getVal('brokerEmail')) errors.push('Broker Email');
    if (!getVal('commission')) errors.push('Commission %');

    return errors;
}

function highlightMissingFields(errors) {
    const fieldMapping = {
        'Asset Class': 'assetClass',
        'Deal Status': 'dealStatus',
        'LOI Date': 'loiDate',
        'Address': 'address',
        'City': 'city',
        'State': 'state',
        'ZIP Code': 'zip',
        'Square Feet': 'sf',
        'Acres': 'acres',
        'Location Highlights': 'locationHighlights',
        'Acquisition Price': 'purchasePrice',
        'LTV %': 'ltv',
        'NOI': 'noi',
        'IRR (5yr)': 'irr',
        'Key Business Initiative #1': 'kbi1',
        'Business Plan': 'businessPlan',
        'Hero Summary': 'heroSummary',
        'Distribution (Annual Cash Flow)': 'estAnnualCashFlow',
        'Number of Tenants': 'numTenants',
        'Occupancy %': 'occupancy',
        'WALT (years)': 'walt',
        'Top Tenant 1 Name': 'tenant1Name',
        'Top Tenant 1 SF Leased': 'tenant1SF',
        'Top Tenant 1 Lease Expiry Date': 'tenant1Expiry',
        'Top Tenant 1 Lease Structure': 'tenant1LeaseStructure',
        'Top Tenant 1 Corp/Personal Guarantee': 'tenant1Guarantee',
        'Top Tenant 2 SF Leased': 'tenant2SF',
        'Top Tenant 2 Lease Expiry Date': 'tenant2Expiry',
        'Top Tenant 2 Lease Structure': 'tenant2LeaseStructure',
        'Top Tenant 2 Corp/Personal Guarantee': 'tenant2Guarantee',
        'Top Tenant 3 SF Leased': 'tenant3SF',
        'Top Tenant 3 Lease Expiry Date': 'tenant3Expiry',
        'Top Tenant 3 Lease Structure': 'tenant3LeaseStructure',
        'Top Tenant 3 Corp/Personal Guarantee': 'tenant3Guarantee',
        'Broker Name': 'brokerName',
        'Broker Company Name': 'brokerCompany',
        'Broker Cell': 'brokerCell',
        'Broker Email': 'brokerEmail',
        'Commission %': 'commission'
    };

    // Find the first missing field and scroll to it
    for (let error of errors) {
        const fieldId = fieldMapping[error];
        if (fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                // Highlight the field temporarily
                field.style.border = '2px solid #ef4444';
                field.style.background = '#fee2e2';

                // Switch to the correct tab if needed
                const detailsFields = [
                    'estAnnualCashFlow', 'numTenants', 'occupancy', 'walt', 'leaseStructure',
                    'tenant1Name', 'tenant1SF', 'tenant1Expiry', 'tenant1Guarantee',
                    'tenant2Name', 'tenant2SF', 'tenant2Expiry', 'tenant2Guarantee',
                    'tenant3Name', 'tenant3SF', 'tenant3Expiry', 'tenant3Guarantee',
                    'brokerName', 'brokerCompany', 'brokerCell', 'brokerEmail', 'commission',
                    'heroSummary'
                ];

                if (detailsFields.includes(fieldId)) {
                    switchTab('details', { target: document.querySelector('.tab-details') });
                }

                // Scroll to field
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                field.focus();

                // Remove highlight after 3 seconds
                setTimeout(() => {
                    field.style.border = '';
                    field.style.background = '';
                }, 3000);

                break; // Only scroll to the first one
            }
        }
    }
}

// Update the submitForReview function
async function submitForReview() {
    // Auto-fill helpful defaults before validation (workaround to reduce friction)
    autoFillDraftDefaults();

    const validationErrors = validateRequiredFields();

    if (validationErrors.length > 0) {
        // Create a nicely formatted error message
        let errorMessage = 'âš ï¸ Please fill in the following required fields:\n\n';
        errorMessage += validationErrors.map((error, index) => `${index + 1}. ${error}`).join('\n');

        alert(errorMessage);

        // Optionally, scroll to the first empty required field
        // Find and focus the first missing field
        highlightMissingFields(validationErrors);

        return; // Stop submission
    }

    const formData = new FormData(document.getElementById('propertyIntakeForm'));

    try {
        const response = await fetch('{% url "add_property" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            alert(`âœ“ Property "${data.title}" created successfully!`);
            // Redirect to dashboard
            window.location.href = '/SE/PD/';
        } else {
            alert('Error: ' + (data.error || 'Unknown error occurred'));
        }
    } catch (error) {
        console.error('Submit error:', error);
        alert('Error creating property. Please try again.');
    }
}

function approveAndPublish() {
    alert('This action is only available when editing an existing property.');
}

function publishToPipeline() {
    alert('This action is only available when editing an existing property.');
}

function addDaysTo(fromId, toId, days) {
    const fromInput = document.getElementById(fromId);
    const toInput = document.getElementById(toId);

    // Add a small delay to ensure date is fully parsed
    setTimeout(() => {
        if (!fromInput.value || fromInput.value === '') {
            alert("Please enter a date in the previous field first.");
            return;
        }

        const fromDate = new Date(fromInput.value);

        // Check if the date is valid
        if (isNaN(fromDate.getTime())) {
            alert("Please enter a valid date in the previous field first.");
            return;
        }

        fromDate.setDate(fromDate.getDate() + days);

        const yyyy = fromDate.getFullYear();
        const mm = String(fromDate.getMonth() + 1).padStart(2, '0');
        const dd = String(fromDate.getDate()).padStart(2, '0');

        toInput.value = `${yyyy}-${mm}-${dd}`;

        // Highlight the selected button
        highlightSelectedButton(toId, days);
    }, 100);
}

function highlightSelectedButton(targetId, selectedDays) {
    // Find the parent date-input-wrapper
    const targetInput = document.getElementById(targetId);
    const wrapper = targetInput.closest('.date-input-wrapper');

    if (!wrapper) return;

    // Remove 'selected' class from all buttons in this wrapper
    const buttons = wrapper.querySelectorAll('.date-buttons button');
    buttons.forEach(btn => btn.classList.remove('selected'));

    // Add 'selected' class to the clicked button
    buttons.forEach(btn => {
        const btnText = btn.textContent.trim();
        if (btnText === `+${selectedDays}`) {
            btn.classList.add('selected');
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Add Property Form Initialized');
    updateProgress();
    initializeImageGrid();

    // AUTO-SELECT PSA +20 and DD END +45
    const loiDateInput = document.getElementById('loiDate');

    loiDateInput.addEventListener('change', function() {
        if (this.value) {
            // Auto-trigger PSA Date +20
            setTimeout(() => {
                addDaysTo('loiDate', 'psaDate', 20);

                // After PSA is filled, auto-trigger DD End +45
                setTimeout(() => {
                    addDaysTo('psaDate', 'ddEnd', 45);
                }, 200);
            }, 100);
        }
    });

    // Also allow DD End to auto-fill if user manually changes PSA Date
    const psaDateInput = document.getElementById('psaDate');
    psaDateInput.addEventListener('change', function() {
        if (this.value) {
            setTimeout(() => {
                addDaysTo('psaDate', 'ddEnd', 45);
            }, 100);
        }
    });
});
function markRequiredFields() {
    const requiredFieldIds = [
        'assetClass', 'dealStatus', 'loiDate',
        'address', 'city', 'state', 'zip', 'sf', 'acres', 'locationHighlights',
        'purchasePrice', 'ltv', 'noi', 'irr',
        'kbi1', 'kbi2', 'businessPlan', 'heroSummary',
        'estAnnualCashFlow',
        'numTenants', 'occupancy', 'walt', 'leaseStructure',
        'tenant1Name', 'tenant1SF', 'tenant1LeaseStructure', 'tenant1Expiry', 'tenant1Guarantee',
        'brokerName', 'brokerCompany', 'brokerCell', 'brokerEmail', 'commission'
    ];

    requiredFieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.classList.add('required-field');

            const checkAndUpdate = () => {
                if (field.value && field.value.trim() !== '' &&
                    field.value !== 'Select...' &&
                    field.value !== 'Deal Status...') {
                    field.classList.add('filled');
                } else {
                    field.classList.remove('filled');
                }
            };

            checkAndUpdate();
            field.addEventListener('input', checkAndUpdate);
            field.addEventListener('change', checkAndUpdate);
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Add Property Form Initialized');
    updateProgress();
    initializeImageGrid();
    attachProgressListeners();
    markRequiredFields(); // ADD THIS LINE

    // AUTO-SELECT PSA +20 and DD END +45
    const loiDateInput = document.getElementById('loiDate');

    loiDateInput.addEventListener('change', function() {
        if (this.value) {
            setTimeout(() => {
                addDaysTo('loiDate', 'psaDate', 20);
                setTimeout(() => {
                    addDaysTo('psaDate', 'ddEnd', 45);
                }, 200);
            }, 100);
        }
    });

    const psaDateInput = document.getElementById('psaDate');
    psaDateInput.addEventListener('change', function() {
        if (this.value) {
            setTimeout(() => {
                addDaysTo('psaDate', 'ddEnd', 45);
            }, 100);
        }
    });
});
</script>
{% endblock %}