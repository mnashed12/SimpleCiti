<!DOCTYPE html>
<html lang="en">
<head>
    {% extends 'sebase.html' %}
    {% load static %}
    {% block title %}Leadership{% endblock %}
    {% block extra_styles %}
    <title>TIC Properties - SimpleEXCHANGE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style>

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "Noto Serif", serif;
    background-image: url('/static/exchangebg.jpg');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    color: var(--text-dark);
    line-height: 1.6;
}

/* Container */
.container {
    margin: 0 auto;
    padding: 0 2rem;
}

/* Hero Banner */
.hero-banner {
    background: linear-gradient(to right, rgba(169, 169, 169, 0.5) 0%, rgba(169, 169, 169, 0.5) 40%, var(--navy-deeper) 40%, var(--navy-deeper) 100%);
    border-radius: 48px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    min-height: 360px;
    width: 1200px;
    margin: 0 auto;
    margin-bottom: 2rem;
}

.hero-content {
    display: grid;
    grid-template-columns: 40% 60%;
    min-height: 360px;
}

.shot-clock-section {
    background-image: url('/static/shotbg.jpg');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.shot-clock-title {
    font-family: 'Playfair Display', serif;
    font-size: 2.5rem;
    font-weight: 300;
    color: var(--white);
    text-transform: uppercase;
    letter-spacing: 3px;
    margin-bottom: 1rem;
    text-align: center;
}

.clock-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    margin-bottom: .5rem;
}

.clock-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: left;
}

.clock-main {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1vh;
}

.flip-clock {
    background: #fff;
    border-radius: 12px;
    padding: 0.75rem;
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    margin: 0;
}

.clock-number {
    font-family: 'Playfair Display', serif;
    font-size: 3.5rem;
    font-weight: 700;
    color: #333;
    line-height: 1;
}

.clock-label {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    text-transform: lowercase;
}

.clock-sublabel {
    font-size: 0.65rem;
    color: black;
    line-height: 1.3;
    margin-top: 0.25rem;
    font-weight: 500;
    text-align: center;
}

.bottom-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    border-top: 2px solid gray;
    width: 400px;
    margin: 0 auto;
    padding-top: 10px;
}

.bottom-stat-item {
    text-align: center;
    border-radius: 8px;
}

.bottom-stat-number {
    font-family: 'Playfair Display', serif;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--white);
    line-height: 1;
    margin-bottom: 0.25rem;
}

.bottom-stat-label {
    font-size: 0.7rem;
    color: black;
    font-weight: 600;
}

.dst-info-section {
    background: var(--navy-deeper);
    padding: 2rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.dst-text {
    font-size: 1.15rem;
    color: var(--white);
    line-height: 1.7;
    margin-bottom: 2rem;
    font-weight: 400;
    text-align: center;
}

.cta-button {
    background: var(--green-button);
    color: var(--white);
    padding: 18px 48px;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 700;
    font-size: 1.2rem;
    display: inline-block;
    text-align: center;
    transition: all 0.3s ease;
    margin-bottom: 2rem;
    border: none;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(74, 124, 89, 0.4);
}

.cta-button:hover {
    background: #5c9e6f;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(74, 124, 89, 0.5);
}

.investment-stats-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 1.1rem;
    color: var(--white);
    font-weight: 600;
    white-space: nowrap;
}

.investment-stats-bar .highlight-box {
    background: var(--white);
    color: #d32f2f;
    padding: 0.4rem 1rem;
    border-radius: 6px;
    font-weight: 700;
}

.investment-stats-bar .deals-count {
    background: var(--white);
    color: var(--navy-dark);
    padding: 0.4rem 1rem;
    border-radius: 6px;
    font-weight: 700;
    min-width: 50px;
    text-align: center;
}

/* Properties Grid */
.properties-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
    margin-bottom: 3rem;
}

/* PROPERTY CARD - EXACT MATCH TO IMAGE */
.property-card {
    background: var(--white);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    display: flex;
    flex-direction: column;
}

.property-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 48px rgba(0,0,0,0.2);
}

.property-image-container {
    position: relative;
    height: 380px;
    overflow: hidden;
}

.property-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.property-card:hover .property-image-container img {
    transform: scale(1.05);
}

/* Top Right Badges */
.property-badges {
    position: absolute;
    top: 0;
    right: 0;
    display: flex;
    flex-direction: row;
    z-index: 10;
}

.badge-available,
.badge-closing {
    background: rgba(37, 37, 86, 0.95);
    color: var(--white);
    padding: 0.75rem 1.25rem;
    backdrop-filter: blur(10px);
    text-align: center;
}

.badge-available {
    border-bottom-left-radius: 16px;
}

.badge-label {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 0.25rem;
    opacity: 0.9;
}

.badge-value {
    font-size: 1rem;
    font-weight: 700;
    line-height: 1.2;
}

.badge-subvalue {
    font-size: 0.75rem;
    font-weight: 600;
    opacity: 0.85;
    line-height: 1.2;
}

/* Property Info Overlay - EXACT MATCH */
.property-info-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(37, 37, 86, 0.95) 0%, rgba(37, 37, 86, 0.25) 60%, transparent 100%);
    z-index: 5;
    padding: 1rem;
}

.property-title-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.property-name {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--white);
    line-height: 1.2;
}

.loi-badge {
    background: #e74c3c;
    color: var(--white);
    padding: 0.35rem 0.9rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.property-address-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
}

.property-type-label {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--white);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.property-address-link {
    font-size: 0.95rem;
    color: var(--green-address);
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.property-address-link:hover {
    color: #7ed87e;
    text-decoration: underline;
}

.maps-icon-img {
    width: 24px;
    height: 24px;
    object-fit: contain;
    transition: transform 0.2s;
}

.property-address-link:hover .maps-icon-img {
    transform: scale(1.15);
}

/* Stats Grid - EXACT COLOR MATCH */
.property-stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    background: transparent;
}

.stat-box {
    border-right: 1px solid rgba(0,0,0,0.1);
    position: relative;
    border-right: 1px solid white;
    margin: 0 .1rem;
}

.stat-box:last-child {
    border-right: none;
}

.stat-label {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: rgba(255, 255, 255, 0.9);
}

.stat-main {
    display: flex;
    align-items: baseline;
    justify-content: center;
    margin-bottom: 0.25rem;
}

.stat-number {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--white);
    line-height: 1;
}

.stat-unit {
    font-size: 1.1rem;
    color: var(--white);
    font-weight: 600;
}

.stat-divider {
    font-size: 1.3rem;
    color: rgba(255, 255, 255, 0.7);
}

.stat-secondary {
    font-size: 1.5rem;
    color: var(--white);
    font-weight: 600;
    white-space: nowrap;
}

.stat-note {
    font-size: 0.6rem;
    color: rgba(255, 255, 255, 0.75);
    font-style: italic;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 2000;
    backdrop-filter: blur(5px);
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--white);
    padding: 2rem;
    max-width: 90vw;
    max-height: 90vh;
    overflow: auto;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e9f0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: var(--text-dark);
    line-height: 1;
}

.map-container {
    width: 95vw;
    height: 90vh;
    border-radius: 8px;
}

/* Enrollment Modal */
.enrollment-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    z-index: 9999;
    overflow-y: auto;
    padding: 2rem;
}

.enrollment-modal-overlay.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.enrollment-modal-container {
    background: var(--white);
    border-radius: 12px;
    max-width: 800px;
    width: 100%;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.enrollment-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: var(--navy-dark);
    color: var(--white);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    z-index: 10;
}

.enrollment-modal-close:hover {
    background: var(--green-button);
    transform: rotate(90deg);
}

.enrollment-modal-header {
    background: linear-gradient(135deg, var(--navy-dark) 0%, var(--navy-deeper) 100%);
    padding: 2rem;
    border-radius: 12px 12px 0 0;
    text-align: center;
}

.enrollment-modal-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--white);
    margin-bottom: 0.5rem;
}

.enrollment-modal-header p {
    font-size: 0.95rem;
    color: rgba(255, 255, 255, 0.85);
    font-weight: 500;
}

.enrollment-form {
    padding: 2rem;
}

.enrollment-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
    margin-bottom: 1.5rem;
}

.enrollment-form-group {
    display: flex;
    flex-direction: column;
}

.enrollment-form-group.full-width {
    grid-column: span 2;
}

.enrollment-form-group label {
    font-size: 0.75rem;
    color: var(--navy-dark);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
}

.enrollment-label-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.enrollment-checkbox-inline {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 7px;
}

.enrollment-checkbox-inline input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--navy-dark);
    margin: 0;
}

.enrollment-checkbox-inline label {
    font-size: 0.7rem;
    color: var(--text-dark);
    cursor: pointer;
    font-weight: 600;
    text-transform: none;
    letter-spacing: normal;
    margin: 0;
}

.enrollment-form-group input[type="text"],
.enrollment-form-group input[type="email"],
.enrollment-form-group input[type="date"] {
    width: 100%;
    padding: 0.875rem;
    border: 2px solid #e5e9f0;
    border-radius: 6px;
    background: var(--white);
    font-size: 0.95rem;
    color: var(--text-dark);
    font-family: 'Montserrat', sans-serif;
    font-weight: 500;
    transition: all 0.3s;
}

.enrollment-form-group input:focus {
    outline: none;
    border-color: var(--navy-dark);
    box-shadow: 0 0 0 4px rgba(31, 31, 77, 0.1);
}

.enrollment-form-group input::placeholder {
    color: #999;
    font-size: 0.9rem;
}

.enrollment-error {
    background: #fee2e2;
    color: #991b1b;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    border-left: 4px solid #ef4444;
}

.enrollment-submit-btn {
    width: 100%;
    background: var(--green-button);
    color: var(--white);
    border: none;
    padding: 1rem 2rem;
    font-family: 'Montserrat', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.3s;
}

.enrollment-submit-btn:hover {
    background: #5c9e6f;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(74, 124, 89, 0.4);
}

.enrollment-submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Footer */
.site-footer {
    background: var(--navy-dark);
    color: var(--white);
    padding: 2rem 1.5rem;
    margin-top: 4rem;
    border-top: 4px solid var(--green-button);
    font-size: 0.85rem;
}

.footer-links {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-bottom: 1rem;
    list-style: none;
}

.footer-links a {
    color: rgba(255, 255, 255, 0.75);
    text-decoration: none;
    transition: color 0.2s ease;
}

.footer-links a:hover {
    color: #fff;
}

.footer-legal {
    font-size: 0.75rem;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.6);
    text-align: center;
    max-width: 1200px;
    margin: 0 auto;
}

.footer-legal p {
    margin-bottom: 0.75rem;
    text-align: justify;
}

/* Responsive */
@media (max-width: 1024px) {
    .hero-content {
        grid-template-columns: 1fr;
    }

    .properties-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    nav {
        padding: 0 1rem;
    }

    .header2, .nav-right {
        display: none;
    }

    .container {
        padding: 0 1rem;
    }

    .property-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .stat-box {
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .stat-box:nth-child(2n) {
        border-right: 1px solid rgba(255,255,255,0.2);
    }

    .enrollment-form-grid {
        grid-template-columns: 1fr;
    }

    .enrollment-form-group.full-width {
        grid-column: span 1;
    }
}

.header5{
    font-size: 2.5rem;
    color: white;
    text-align: center;
    margin-top: 11vh;
    line-height: 1;
    font-weight: 700;
}

.header6{
    font-size: 1.5rem;
    color: white;
    text-align: center;
    margin-bottom: 2vh;
    font-weight: 700;
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--navy-dark);
}

.nav-link.user-profile {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
    </style>
</head>
<body>
{% endblock %}

{% block content %}

    <!-- Enrollment Modal -->
    <div id="enrollmentModalOverlay" class="enrollment-modal-overlay">
        <div class="enrollment-modal-container">
            <button class="enrollment-modal-close" onclick="closeEnrollmentModal()">&times;</button>

            <div class="enrollment-modal-header">
                <h2>Start Your 1031 Exchange Process</h2>
                <p>Tell us about your transaction to view property details</p>
            </div>

            <form id="enrollmentForm" class="enrollment-form">
                <div class="enrollment-form-grid">
                    <div class="enrollment-form-group full-width">
                        <label for="enrollment-email">Email Address *</label>
                        <input type="email" id="enrollment-email" name="email" placeholder="investor@example.com" required>
                    </div>

                    <div class="enrollment-form-group">
                        <label for="enrollment-sale-price">Sale Price - Relinquished Asset *</label>
                        <input type="text" id="enrollment-sale-price" name="sale_price" placeholder="$12,500,000" required>
                    </div>

                    <div class="enrollment-form-group">
                        <label for="enrollment-equity">Equity Rollover - Replacement 1031 Asset *</label>
                        <input type="text" id="enrollment-equity" name="equity_rollover" placeholder="$6,000,000" required>
                    </div>

                    <div class="enrollment-form-group">
                        <label for="enrollment-closing-date">Relinquish Closing Date *</label>
                        <input type="date" id="enrollment-closing-date" name="closing_date" required>
                    </div>

                    <div class="enrollment-form-group">
                        <div class="enrollment-label-row">
                            <label for="enrollment-qi">Qualified Intermediary</label>
                            <div class="enrollment-checkbox-inline">
                                <input type="checkbox" id="enrollment-qi-referral" name="needs_qi_referral">
                                <label for="enrollment-qi-referral">Need Referral</label>
                            </div>
                        </div>
                        <input type="text" id="enrollment-qi" name="qi_name" placeholder="Enter Qualified Intermediary name">
                    </div>
                </div>

                <input type="hidden" id="enrollment-property-id" name="property_id">
                <div id="enrollmentError" class="enrollment-error" style="display: none;"></div>

                <button type="submit" class="enrollment-submit-btn">
                    <span id="enrollmentBtnText">Start My 1031 Process</span>
                    <span id="enrollmentBtnLoading" style="display: none;">Processing...</span>
                </button>
            </form>
        </div>
    </div>

    <h1 class="header5">DSTs box you in with no say on refinance or sale</h1>
    <h2 class="header6">1031 Preserves Optionality- No DST Handcuffs, No Forced UPREIT Stock Rollovers</h2>

    <div class="container">
        <!-- Hero Banner -->
        <div class="hero-banner">
            <div class="hero-content">
                <div class="shot-clock-section">
                    <div class="shot-clock-title">YOUR SHOT CLOCK</div>

                    <div class="clock-grid">
                        <div class="clock-item">
                            <div class="clock-main">
                                <div class="flip-clock">
                                    <div class="clock-number" id="days45">45</div>
                                </div>
                                <div class="clock-label">days<br> remain</div>
                            </div>
                            <div class="clock-sublabel">
                                Up to three potential<br>replacement properties<br>must be identified within<br>45 days of the sale
                            </div>
                        </div>

                        <div class="clock-item">
                            <div class="clock-main">
                                <div class="flip-clock">
                                    <div class="clock-number" id="days180">180</div>
                                </div>
                                <div class="clock-label">days<br> remain</div>
                            </div>
                            <div class="clock-sublabel">
                                Replacement property must<br>be purchased within<br>180 days of the sale
                            </div>
                        </div>
                    </div>

                    <div class="bottom-stats">
                        <div class="bottom-stat-item">
                            <div class="bottom-stat-number">$3.5B+</div>
                            <div class="bottom-stat-label">Lost annually by missed<br>1031 deadlines</div>
                        </div>
                        <div class="bottom-stat-item">
                            <div class="bottom-stat-number">7-10 <span style="font-size: 1.5rem;">Years</span></div>
                            <div class="bottom-stat-label">Lost long DSTs can lock<br>your capital away</div>
                        </div>
                    </div>
                </div>

                <div class="dst-info-section">
                    <p class="dst-text">
                        At the end of term, DST investors are forced into 721 UPREITs—rolling into some other companies stock, losing tax flexibility, stuck with their manager's timelines, refis, and decisions. Our Non-DST 1031 preserves real control: investors decide when to sell, refinance, or exit—protecting liquidity, optionality, and upside on their terms.
                    </p>

                    <button class="cta-button" onclick="return false;">Click to start today</button>

                    <div class="investment-stats-bar">
                        Pipeline Properties:
                        <span class="highlight-box" id="pipelineDealsTotal">Loading...</span>
                        Across
                        <span class="deals-count" id="pipelineDealsCount">0</span>
                        Deals
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Grid -->
        <div class="properties-grid" id="pipelineDealsGrid">
            <!-- Property cards generated by JavaScript -->
        </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalPropertyTitle">Property Location</h3>
                <button class="modal-close" onclick="closeMapModal()">&times;</button>
            </div>
            <div class="map-container">
                <iframe id="mapFrame" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
            </div>
        </div>
    </div>

<script>
let propertyData = { pipelineDeals: [] };

function calculateDaysUntilClosing(closeDate) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const close = new Date(closeDate);
    close.setHours(0, 0, 0, 0);
    return Math.max(0, Math.ceil((close - today) / (1000 * 3600 * 24)));
}

function formatClosingDate(closeDate) {
    const date = new Date(closeDate);
    return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
}

document.addEventListener('DOMContentLoaded', loadPropertiesFromAPI);

async function loadPropertiesFromAPI() {
    try {
        const response = await fetch('/api/pipeline_properties/');
        const data = await response.json();

        if (data.properties) {
            propertyData.pipelineDeals = data.properties;
            initializePage();
        }
    } catch (error) {
        console.error('Error loading properties:', error);
    }
}

function initializePage() {
    const grid = document.getElementById('pipelineDealsGrid');

    if (propertyData.pipelineDeals.length === 0) {
        grid.innerHTML = '<p style="text-align:center; color:white; font-size:1.5rem; grid-column: 1/-1;">No pipeline properties at this time. Check back soon!</p>';
        document.getElementById('pipelineDealsTotal').textContent = '$0';
        document.getElementById('pipelineDealsCount').textContent = '0';
        return;
    }

    grid.innerHTML = propertyData.pipelineDeals.map(generatePropertyCard).join('');

    const totalValue = propertyData.pipelineDeals.reduce((sum, p) => sum + p.targetEquity, 0);
    document.getElementById('pipelineDealsCount').textContent = propertyData.pipelineDeals.length;
    document.getElementById('pipelineDealsTotal').textContent = `$${(totalValue / 1000000).toFixed(2)}M Total`;
}

function navigateToDeal(propertyId, event) {
    if (event.target.closest('.property-address-link')) {
        return;
    }

    if (hasEnrolled()) {
        window.location.href = `/SE/deal-detail/${propertyId}/`;
    } else {
        event.preventDefault();
        event.stopPropagation();
        showEnrollmentModal(propertyId);
    }
}

function openMapModal(address, title) {
    const modal = document.getElementById('mapModal');
    const frame = document.getElementById('mapFrame');
    document.getElementById('modalPropertyTitle').textContent = title;
    frame.src = `https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodeURIComponent(address)}&zoom=15&maptype=satellite`;
    modal.style.display = 'block';
}

function closeMapModal() {
    document.getElementById('mapModal').style.display = 'none';
    document.getElementById('mapFrame').src = '';
}

window.onclick = function(event) {
    if (event.target === document.getElementById('mapModal')) closeMapModal();
}

function generatePropertyCard(property) {
    const days = calculateDaysUntilClosing(property.closeDate);
    const closeDate = formatClosingDate(property.closeDate);
    const imageUrl = (property.images && property.images.length > 0) ? property.images[0] : 'https://via.placeholder.com/800x600?text=Property';
    const available = property.targetEquity - property.currentFunding;

    return `
    <div class="property-card" onclick="navigateToDeal('${property.id}', event)">
        <div class="property-image-container">
            <img src="${imageUrl}" alt="${property.title}">

            <div class="property-badges">
                <div class="badge-available">
                    <div class="badge-label">AVAILABLE</div>
                    <div class="badge-value">Slots: $${(available / 1000000).toFixed(1)}M</div>
                    <div class="badge-subvalue">For 1-5 Parties</div>
                </div>

                <div class="badge-closing">
                    <div class="badge-label">CLOSING DATE</div>
                    <div class="badge-value">${closeDate}</div>
                    <div class="badge-subvalue">IN ${days} Days</div>
                </div>
            </div>

            <div class="property-info-overlay">
                <div class="property-title-row">
                    <div class="property-name">${property.title}</div>
                    <div class="loi-badge">${property.dealStage || 'LOI OUT'}</div>
                </div>

                <div class="property-address-row">
                    <div class="property-type-label">${property.type.toUpperCase()} ASSET,</div>
                    <a href="#" class="property-address-link" onclick="event.stopPropagation(); openMapModal('${property.address.replace(/'/g, "\\'")}', '${property.title.replace(/'/g, "\\'")}'); return false;">
                        ${property.address}

                    </a>
                </div>
                        <div class="property-stats-grid">
            <div class="stat-box noi">
                <div class="stat-label">IN PLACE NOI</div>
                <div class="stat-main">
                    <span class="stat-number">${property.stats.inPlaceNOI.percent.toFixed(2)}</span>
                    <span class="stat-unit">%</span>
                    <span class="stat-divider">|</span>
                    <span class="stat-secondary">$${(property.stats.inPlaceNOI.amount / 1000).toFixed(0)}K</span>
                </div>
            </div>

            <div class="stat-box coupon">
                <div class="stat-header">
                    <div class="stat-label">COUPON</div>
                    <div class="stat-note">*Based on ${property.ltvPercent}% LTV</div>
                </div>
                <div class="stat-main">
                    <span class="stat-number">${property.stats.coupon.percent.toFixed(2)}</span>
                    <span class="stat-unit">%</span>
                    <span class="stat-divider">|</span>
                    <span class="stat-secondary">$${(property.stats.coupon.amount / 1000000).toFixed(1)}M</span>
                </div>
            </div>

            <div class="stat-box cap-rate">
                <div class="stat-label">PURCHASE CAP RATE</div>
                <div class="stat-main">
                    <span class="stat-number">${property.stats.purchaseCapRate.percent.toFixed(2)}</span>
                    <span class="stat-unit">%</span>
                    <span class="stat-divider">|</span>
                    <span class="stat-secondary">$${(property.totalValue / 1000).toFixed(0)}K</span>
                </div>
            </div>

            <div class="stat-box irr">
                <div class="stat-label">PROJECTED IRR</div>
                <div class="stat-main">
                    <span class="stat-number">${property.stats.projectedIRR.percent.toFixed(1)}</span>
                    <span class="stat-unit">%</span>
                    <span class="stat-divider">|</span>
                    <span class="stat-secondary">${property.stats.projectedIRR.years} Years</span>
                </div>
            </div>
        </div>
            </div>
        </div>


    </div>
    `;
}

// Enrollment Modal Functions
let selectedPropertyId = null;

function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function hasEnrolled() {
    return getCookie('enrollment_completed') === 'true';
}

function showEnrollmentModal(propertyId) {
    selectedPropertyId = propertyId;
    document.getElementById('enrollment-property-id').value = propertyId;
    document.getElementById('enrollmentModalOverlay').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeEnrollmentModal() {
    document.getElementById('enrollmentModalOverlay').classList.remove('active');
    document.body.style.overflow = '';
    document.getElementById('enrollmentForm').reset();
    document.getElementById('enrollmentError').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('enrollmentModalOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeEnrollmentModal();
    });

    const formatCurrency = (input) => {
        let value = input.value.replace(/[^\d.]/g, '');
        if (value) {
            const parts = value.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            if (parts[1]) parts[1] = parts[1].substring(0, 2);
            input.value = '$' + parts.join('.');
        }
    };

    ['enrollment-sale-price', 'enrollment-equity'].forEach(id => {
        const input = document.getElementById(id);
        input.addEventListener('input', () => formatCurrency(input));
        input.addEventListener('blur', function() {
            if (!this.value.startsWith('$')) this.value = '$' + this.value;
        });
    });

    const qiCheckbox = document.getElementById('enrollment-qi-referral');
    const qiInput = document.getElementById('enrollment-qi');
    qiCheckbox.addEventListener('change', function() {
        qiInput.disabled = this.checked;
        qiInput.placeholder = this.checked ? 'We will provide a referral' : 'Enter Qualified Intermediary name';
        qiInput.value = '';
        qiInput.style.opacity = this.checked ? '0.6' : '1';
    });

    document.getElementById('enrollmentForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        formData.set('sale_price', formData.get('sale_price').replace(/[$,]/g, ''));
        formData.set('equity_rollover', formData.get('equity_rollover').replace(/[$,]/g, ''));

        const btn = this.querySelector('button[type="submit"]');
        const btnText = document.getElementById('enrollmentBtnText');
        const btnLoading = document.getElementById('enrollmentBtnLoading');

        btn.disabled = true;
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline';
        document.getElementById('enrollmentError').style.display = 'none';

        try {
            const response = await fetch('/SE/enrollment/submit/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1]
                }
            });

            const data = await response.json();

            if (data.success) {
                setCookie('enrollment_completed', 'true', 365);
                closeEnrollmentModal();
                window.location.href = `/SE/deal-detail/${selectedPropertyId}/`;
            } else {
                const errorDiv = document.getElementById('enrollmentError');
                errorDiv.textContent = data.error || 'An error occurred. Please try again.';
                errorDiv.style.display = 'block';

                btn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
            }
        } catch (error) {
            console.error('Enrollment error:', error);

            const errorDiv = document.getElementById('enrollmentError');
            errorDiv.textContent = 'Network error. Please check your connection and try again.';
            errorDiv.style.display = 'block';

            btn.disabled = false;
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
        }
    });
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('enrollmentModalOverlay').classList.contains('active')) {
        closeEnrollmentModal();
    }
});
</script>
</body>
{% endblock %}
</html>