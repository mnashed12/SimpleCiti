{% extends 'sebase.html' %}
{% load static %}
{% block title %}Deal Details - Simple1031â„¢{% endblock %}
{% block extra_styles %}
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
:root {
    /* Brand Colors */
    --navy-dark: rgb(20, 17, 60);
    --navy-deeper: #252556;
    --green-button: #4a7c59;
    --green-address: #5cb85c;
    --white: #ffffff;
    --light-gray: #f5f7fa;
    --text-dark: #2c3e50;
    --yellow: #FFC107;
    --yellow-dark: #FFB300;
    
    /* Typography - Simplified to 3 sizes */
    --text-large: 1.5rem;
    --text-base: 1rem;
    --text-small: 0.75rem;
    
    /* Spacing - Reduced */
    --space-xs: 0.25rem;
    --space-sm: 0.5rem;
    --space-md: 0.75rem;
    --space-lg: 1rem;
    --space-xl: 1.5rem;
    
    /* Shadows */
    --shadow-sm: 0 0.125rem 0.5rem rgba(0,0,0,0.1);
    --shadow-md: 0 0.5rem 1.25rem rgba(0,0,0,0.15);
    --shadow-lg: 0 0.5rem 2rem rgba(0,0,0,0.2);
    
    /* Gradients */
    --gradient-primary: linear-gradient(135deg, var(--navy-dark) 0%, var(--navy-deeper) 100%);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--navy-dark);
    color: var(--text-dark);
    line-height: 1.6;
    min-height: 100vh;
    scroll-behavior: smooth;
}

.container {
    max-width: 1550px;
    margin: 0 auto;
    margin-top: 100px;
    padding: 0 1rem;
}

/* Property Title Header - Streamlined */
.property-title-header {
    background: #2c2a58;
    padding: 0rem 2rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid rgba(255, 193, 7, 0.2);
    position: relative;
    overflow: hidden;
}

.deal-top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between; /* create big gap between address and stats */
    gap: 1.4rem;
    font-size: 0.85rem;
    line-height: 1;
    white-space: nowrap;
}

.deal-left {
    display: flex;
    align-items: center;
    gap: 0.9rem;
}

.deal-right {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-left: auto; /* ensure right group is pushed to the right */
}

.deal-map-pin {
    width: 40px; /* larger pin */
    height: 52px; /* larger pin */
    background: none;
    border: none;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}
.deal-map-pin img {width:100%;height:100%;object-fit:contain;}

.deal-address {
    font-family: 'Playfair Display', serif;
    font-size: 1.7rem;
    font-weight: 700;
    color: #fff;
    letter-spacing: 0.05em;
    margin: 0;
}

.deal-stage-holder .property-stage-badge {
    background: linear-gradient(135deg,#4a7c59,#5cb85c);
    padding: 0.35rem 0.9rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: .08em;
}

.deal-meta-label {
    color: #a9a7ec;
    font-weight: 600;
    font-size: 1rem;
    letter-spacing: .08em;
    margin-right: .35rem;
}
.deal-meta-value {
    color: #fff;
    font-weight: 600;
    font-size: 1rem;
    letter-spacing: .05em;
}

.deal-asset-type {
    color: #a9a7ec;
    font-weight: 600;
    font-size: 1rem;
    letter-spacing: .12em;
    text-transform: uppercase;
}

.deal-ref {
    color: white;
    font-weight: 700;
    font-size: 1rem;
    letter-spacing: .08em;
}

.property-title-left {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.property-maps-icon {
    width: 35px;
    height: 45px;
    border: none;
    padding: 0;
    margin: 0;
    background: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
    flex-shrink: 0;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

.property-maps-icon:hover {
    transform: scale(1.1);
}

.property-maps-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
}

.property-title-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.property-asset-badge {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--navy-dark);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    background: var(--yellow);
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
}

.property-reference-number {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--yellow);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.08);
}

.property-header-subtitle {
    font-size: 0.85rem;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.8);
    letter-spacing: 0.02em;
    padding: 0.5rem 0;
    border-top: 1px solid rgba(255, 193, 7, 0.2);
    line-height: 1.4;
}

.property-info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(255, 193, 7, 0.2);
}

.info-left {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.info-item {
    font-size: 0.75rem;
    font-weight: 600;
    color: #ffffff;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.info-label {
    color: var(--yellow);
    margin-right: 0.25rem;
}

.info-right {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.property-stage-badge {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--white);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.4rem 0.75rem;
    border-radius: 4px;
    background: linear-gradient(135deg, var(--green-button) 0%, var(--green-address) 100%);
}

/* Enhanced Photo Carousel */
.hero-split-view {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    min-height: 500px;
    box-shadow: var(--shadow-lg);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: none;
    border-radius: 0 0 16px 16px;
    overflow: hidden;
}

.photo-carousel {
    position: relative;
    height: 100%;
    min-height: 500px;
    overflow: hidden;
    background: #000;
}

.photo-carousel-right {
    background: #0a0a0a; /* subtle contrast */
}

.carousel-container {
    position: relative;
    width: 100%;
    height: 100%;
}

.carousel-slide {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.5s ease;
}

.carousel-slide.active {
    opacity: 1;
}

.carousel-slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.carousel-nav {
    position: absolute;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.5rem;
    z-index: 15;
    background: rgba(0, 0, 0, 0.4);
    padding: 0.5rem 1rem;
    border-radius: 50px;
    backdrop-filter: blur(10px);
}

.carousel-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.2s ease;
}

.carousel-dot.active {
    background: var(--yellow);
    transform: scale(1.3);
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.6);
}

.carousel-prev, .carousel-next {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 56px;
    background: linear-gradient(90deg, rgba(0,0,0,0.35), rgba(0,0,0,0));
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 1.25rem;
    opacity: 0; /* show on hover */
    transition: opacity .2s ease;
    z-index: 15;
    /* static hover gradients only (no animation) */
}
.photo-carousel:hover .carousel-prev,
.photo-carousel:hover .carousel-next { opacity: 1; }

.carousel-next { right: 0; background: linear-gradient(270deg, rgba(0,0,0,0.35), rgba(0,0,0,0)); }
.carousel-prev { left: 0; }

.carousel-prev i, .carousel-next i {
    border: solid #fff;
    border-width: 0 3px 3px 0;
    display: inline-block;
    padding: 6px;
    transform: rotate(135deg); /* left */
}
.carousel-next i { transform: rotate(-45deg); }

/* Hover color and overlay per request: white at 0.7 */
.carousel-prev:hover { background: linear-gradient(90deg, rgba(255,255,255,0.7), rgba(255,255,255,0)); }
.carousel-next:hover { background: linear-gradient(270deg, rgba(255,255,255,0.7), rgba(255,255,255,0)); }
.carousel-prev:hover i, .carousel-next:hover i { border-color: rgba(255,255,255,0.7); }

/* Remove solid white override: keep directional fade (left -> right, right -> left) */
/* Left arrow fades from white on its left edge to transparent toward the right */
/* Right arrow fades from white on its right edge to transparent toward the left */
/* (Existing individual hover rules above already set these gradients; this block had overridden them) */

/* Removed sweep animations per request; keep simple directional fades */

/* Info Panel (Right Side) */
.info-panel {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-left: 1px solid rgba(255, 255, 255, 0.2);
}

.info-panel-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.info-panel-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

/* Hero Metrics Bar */
.hero-metrics {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 2rem;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 0 0 16px 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: none;
    margin-bottom: 2rem;
}

.hero-metric {
    text-align: center;
}

.hero-value {
    font-size: 2.25rem;
    font-weight: 800;
    color: var(--yellow);
    line-height: 1;
    font-family: 'IBM Plex Mono', monospace;
    font-variant-numeric: tabular-nums;
}

.hero-label {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-top: 0.5rem;
}

/* Description Section */
.description-section {
    margin-top: 1.5rem;
}

.description-text {
    color: white;
    font-size: 1rem;
    line-height: 1.8;
    background: rgba(255, 255, 255, 0.03);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Section Headers - Clean & Minimal */
.section-header {
    background: #2c2a58;
    color: #a9a7ec;
    font-size: 0.9rem;
    font-weight: 700;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin: 2rem 0 1rem 0;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-top: 0;
}

/* New: Section navigation */
.section-nav {
    position: sticky;
    top: 64px;
    z-index: 20;
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem 0.25rem;
    margin: 1.25rem 0;
    background: linear-gradient(180deg, rgba(20,17,60,0.95), rgba(20,17,60,0.6));
    backdrop-filter: blur(6px);
    border: 1px solid rgba(255,255,255,0.08);
    border-left: 0;
    border-right: 0;
}

.nav-pill {
    color: rgba(255,255,255,0.85);
    font-weight: 600;
    font-size: 0.85rem;
    letter-spacing: 0.04em;
    text-decoration: none;
    padding: 0.5rem 0.9rem;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.06);
    transition: all .2s ease;
}
.nav-pill:hover { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.28); }

/* New: Content layout */
.content-layout {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
    align-items: start;
}

.main-column { display: flex; flex-direction: column; gap: 1.25rem; }

/* Two-up layout for adjacent sections (e.g., Financials + Returns) */
.two-up-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; align-items: start; }

.section-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 1rem;
    scroll-margin-top: 130px; /* offset for sticky nav */
}

.subsection-title {
    color: rgba(255,255,255,0.7);
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* New: Side rail */
.side-rail { position: sticky; top: 170px; height: fit-content; }

.side-card {
    background: linear-gradient(180deg, rgba(37,37,86,0.65), rgba(20,17,60,0.65));
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: var(--shadow-md);
}

.side-card-header {
    color: #a9a7ec;
    font-size: 0.95rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08rem;
    margin-bottom: 0.75rem;
}

.summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem 1rem;
}
.summary-item { display: flex; flex-direction: column; }
.summary-label { color: rgba(255,255,255,0.6); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; }
.summary-value { color: var(--yellow); font-weight: 800; font-size: 1.25rem; font-family: 'IBM Plex Mono', monospace; }

.summary-chips { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
.chip { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 999px; padding: 0.35rem 0.6rem; display: inline-flex; gap: 0.4rem; align-items: center; }
.chip-label { color: rgba(255,255,255,0.6); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; }
.chip-value { color: #fff; font-weight: 700; font-size: 0.85rem; }

.summary-tags { display: flex; gap: 0.5rem; margin-top: 0.75rem; align-items: center; flex-wrap: wrap; }
.tag { color: #fff; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; padding: 0.35rem 0.5rem; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.06em; }

.cta-group { display: grid; grid-template-columns: 1fr; gap: 0.5rem; margin-top: 1rem; }
.cta-button { display: inline-block; text-align: center; padding: 0.6rem 0.9rem; border-radius: 8px; font-weight: 700; letter-spacing: 0.04em; text-decoration: none; }
.cta-button.primary { background: var(--yellow); color: var(--navy-dark); }
.cta-button.secondary { background: rgba(255,255,255,0.06); color: #fff; border: 1px solid rgba(255,255,255,0.18); }
.cta-button.secondary:hover { background: rgba(255,255,255,0.12); }

/* Sidebar overview description */
.side-description {
    color: rgba(255,255,255,0.9);
    font-size: 0.95rem;
    line-height: 1.65;
    letter-spacing: 0.01em;
}
.side-description p { margin: 0 0 0.75rem 0; }
.side-description p:last-child { margin-bottom: 0; }
.side-description p.lead { font-size: 1rem; font-weight: 600; color: #fff; }
.side-description .keyword { color: var(--yellow); font-weight: 700; }
.side-description .emphasis { background: rgba(255,255,255,0.08); padding: 0 0.35rem; border-radius: 4px; }
.side-description .fade-gradient { position: relative; }

/* Tenancy grid refinement - compact single-column layout */
.tenancy-grid { display: flex; flex-direction: column; gap: 1rem; }

/* Responsive adjustments for new layout */
@media (max-width: 1200px) {
    .content-layout { grid-template-columns: 1fr; }
    .side-rail { position: static; }
    .two-up-grid { grid-template-columns: 1fr; }
}

@media (max-width: 768px) {
    .section-nav { top: 56px; padding: 0.5rem 0.25rem; gap: 0.35rem; }
    .nav-pill { padding: 0.4rem 0.7rem; font-size: 0.8rem; }
    .tenancy-overview { grid-template-columns: 1fr; }
    .tenant-card-content { grid-template-columns: repeat(2, 1fr); }
}

/* Stats Wrapper - Reduced spacing */
.stats-wrapper {
    margin: 1rem auto;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.stats-individual {
    display: flex;
    flex-direction: column;
}

.detail-section {
    padding-top: 0.5rem;
}

/* Metrics Table - Clean Data Presentation */
.metrics-table {
    display: grid;
    gap: 0.25rem;
}

.metrics-row {
    display: grid;
    grid-template-columns: 160px 220px 180px 1fr; /* fixed widths align second column labels */
    gap: 1rem;
    padding: 0.35rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    align-items: center;
}

.metrics-row .label {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.metrics-row .value {
    font-size: 1rem;
    font-weight: 700;
    color: white;
    text-align: right;
    font-family: 'IBM Plex Mono', monospace;
    font-variant-numeric: tabular-nums;
}

/* Property Details Grid - 3 Column */
.property-details-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
}

.detail-column {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.detail-label {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.detail-value {
    font-size: 1rem;
    font-weight: 600;
    color: white;
    font-family: 'IBM Plex Mono', monospace;
}

/* Returns Display - Prominent */
.returns-display {
    display: grid;
    grid-template-columns: 1fr 1fr; /* stack return items */
    gap: 1rem;
    padding: 1.25rem;
    background: rgba(92, 184, 92, 0.08);
    border-radius: 12px;
    border: 2px solid rgba(92, 184, 92, 0.3);
}

.return-item {
    text-align: center;
}

.return-value {
    font-size: 2.25rem;
    font-weight: 800;
    color: var(--green-address);
    font-family: 'IBM Plex Mono', monospace;
    font-variant-numeric: tabular-nums;
    line-height: 1;
}

.return-label {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.5rem;
}

.return-sublabel {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.5);
    margin-top: 0.25rem;
}

/* Tenancy Section - compact horizontal stats */
.tenancy-overview {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.tenancy-stat {
    text-align: center;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.tenancy-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--yellow);
    font-family: 'IBM Plex Mono', monospace;
    line-height: 1;
}

.tenancy-stat-label {
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.5rem;
}

/* Tenant Cards - compact table-like display */
.tenant-cards {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.tenant-card {
    background: rgba(255, 255, 255, 0.03);
    padding: 0.75rem 1rem;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: background 0.2s ease;
}

.tenant-card:hover {
    background: rgba(255, 255, 255, 0.06);
}

.tenant-name {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--white);
    margin-bottom: 0.5rem;
}

.tenant-card-content {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
    align-items: center;
}

.tenant-card-column {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.tenant-detail {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
}

.tenant-detail-label {
    color: rgba(255, 255, 255, 0.5);
    font-weight: 500;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}

.tenant-detail-value {
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--white);
    font-family: 'IBM Plex Mono', monospace;
}

/* Strategy Section - Editorial Style */
.strategy-grid {
    display: grid;
    grid-template-columns: 1.4fr 1fr;
    gap: 2.5rem;
    align-items: start;
}

/* Business Plan - Book/Newspaper aesthetic */
.strategy-content {
    background: none;
    padding: 0;
    border: none;
    color: rgba(255, 255, 255, 0.92);
    line-height: 1.85;
    font-size: 1rem;
    font-family: 'IBM Plex Sans', -apple-system, sans-serif;
    text-align: justify;
    hyphens: auto;
    column-count: 1;
    position: relative;
}

.strategy-content::first-letter {
    font-size: 3.5rem;
    font-weight: 700;
    line-height: 0.85;
    float: left;
    margin: 0.1rem 0.15rem 0 0;
    color: var(--yellow);
    font-family: 'Playfair Display', serif;
}

/* Key Initiatives - Numbered cards */
.kbi-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    counter-reset: kbi-counter;
}

.kbi-item {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.08), rgba(255, 193, 7, 0.02));
    padding: 1rem 1rem 1rem 3.5rem;
    border-radius: 8px;
    border: 1px solid rgba(255, 193, 7, 0.2);
    border-left: 3px solid var(--yellow);
    color: var(--white);
    font-size: 0.9rem;
    position: relative;
    line-height: 1.6;
    counter-increment: kbi-counter;
    transition: all 0.2s ease;
}

.kbi-item:hover {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.12), rgba(255, 193, 7, 0.04));
    border-left-width: 4px;
    transform: translateX(2px);
}

.kbi-item::before {
    content: counter(kbi-counter);
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    width: 1.75rem;
    height: 1.75rem;
    background: var(--yellow);
    color: var(--navy-dark);
    font-size: 0.85rem;
    font-weight: 800;
    font-family: 'IBM Plex Mono', monospace;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}

/* More Opportunities - Full Width Pre-Footer Section */
.opportunities-section {
    margin: 3rem 0 2rem 0;
    padding: 2rem 0;
    background: rgba(255, 255, 255, 0.01);
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.opportunities-section .section-header {
    text-align: center;
    font-size: 1.5rem;
    margin-bottom: 2rem;
}

.opportunities-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.25rem;
    max-width: 1550px;
    margin: 0 auto;
    padding: 0 1rem;
}

.opportunity-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
}

.opportunity-card:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 193, 7, 0.3);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.opportunity-image {
    width: 100%;
    height: 180px;
    object-fit: cover;
    background: rgba(255, 255, 255, 0.03);
}

.opportunity-content {
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    flex: 1;
}

.opportunity-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    line-height: 1.3;
    margin: 0;
}

.opportunity-type {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    background: rgba(255, 193, 7, 0.15);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--yellow);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    width: fit-content;
}

.opportunity-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    margin-top: auto;
}

.opportunity-metric {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
}

.opportunity-metric-label {
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.opportunity-metric-value {
    font-size: 0.9rem;
    font-weight: 800;
    color: var(--yellow);
    font-family: 'IBM Plex Mono', monospace;
}

.loading-placeholder {
    grid-column: 1 / -1;
    text-align: center;
    padding: 2rem;
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
}

.investor-disclaimer {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
    margin-bottom: 1rem;
    white-space: nowrap;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 2000;
    backdrop-filter: blur(8px);
    overflow-y: auto;
    padding: 2rem;
}

.modal-content {
    position: relative;
    background: var(--white);
    border-radius: 16px;
    padding: 2rem;
    margin: auto;
    max-width: 90vw;
    width: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-lg);
    max-height: calc(100vh - 4rem);
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e2e8f0;
}

.modal-header h3 {
    font-size: 1.25rem;
    color: var(--navy-dark);
    font-weight: 700;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.75rem;
    cursor: pointer;
    color: var(--text-dark);
    transition: all 0.2s ease;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.modal-close:hover {
    background: #f1f5f9;
    color: #ef4444;
}

/* Service Fees Modal Specific Styles */
.fees-modal-content { max-width: 640px; }
.fees-modal-body { display: flex; flex-direction: column; }
.fee-item { display: flex; align-items: center; gap: 1.25rem; padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; background: #ffffff; }
.fee-item:nth-child(even) { background: #f8fafc; }
.fee-item:last-child { border-bottom: none; }
.fee-icon { width: 120px; height: 54px; padding: 6px; display: flex; align-items: center; justify-content: center; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; color: #475569; flex-shrink: 0; overflow: hidden; box-sizing: border-box; }
.fee-icon img { width: 100%; height: 100%; object-fit: contain; display: block; }
.fee-details { display: flex; flex-direction: column; gap: .35rem; }
.fee-name { font-size: 1rem; font-weight: 700; color: var(--navy-dark); letter-spacing: .02em; }
.fee-rate { font-size: .85rem; font-weight: 600; color: #64748b; letter-spacing: .02em; font-family: 'IBM Plex Mono', monospace; }
.fees-modal-disclaimer { font-size: .65rem; color:#64748b; text-transform: uppercase; letter-spacing:.1em; margin-top: .75rem; text-align: right; }

.map-container {
    width: 100%;
    height: 70vh;
    border-radius: 8px;
    overflow: hidden;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .stats-row {
        grid-template-columns: 1fr;
    }
    
    .opportunities-grid {
        grid-template-columns: 1fr;
    }
    
    .property-details-grid {
        grid-template-columns: 1fr;
    }
    
    .strategy-grid {
        grid-template-columns: 1fr;
    }
    
    /* Financial and Property Details side by side */
    .financial-overview-container {
        grid-template-columns: 1fr !important;
    }
    
    /* Tenancy overview and cards */
    div[style*="grid-template-columns: 300px 1fr"] {
        grid-template-columns: 1fr !important;
    }
}

@media (max-width: 480px) {
    .fee-item { gap: 1rem; padding: 1rem 1.25rem; }
    .fee-icon { width: 40px; height: 40px; padding: 6px; }
}

@media (max-width: 768px) {
    .container {
        margin-top: 80px;
        padding: 0 0.5rem;
    }

    .property-title-header {
        padding: 1rem;
    }

    .property-header-main {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .property-title-left {
        font-size: 1.1rem;
    }

    .photo-carousel {
        height: 350px;
    }

    .hero-metrics {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        padding: 1.25rem;
    }

    .hero-value {
        font-size: 1.75rem;
    }

    .metrics-row {
        grid-template-columns: 1fr auto;
        gap: 1rem;
    }

    .metrics-row .label:nth-child(3),
    .metrics-row .value:nth-child(4) {
        display: none;
    }

    .returns-display {
        grid-template-columns: 1fr;
    }

    .tenancy-overview {
        grid-template-columns: 1fr;
    }

    .tenant-card-content {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
    
    /* Override inline grid styles for mobile */
    div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }
}

@media (max-width: 480px) {
    .property-title-left {
        font-size: 1rem;
    }

    .section-header {
        font-size: 0.85rem;
    }

    .hero-metrics {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
{% endblock %}

{% block content %}

    <div class="container">
        <!-- Property Header Reformatted Top Bar -->
        <div class="property-title-header">
            <div class="deal-top-bar">
                <div class="deal-left">
                    <button class="deal-map-pin" onclick="openMapModal()" title="View on Google Maps">
                        <img src="/static/googlepin.png" alt="Map Pin">
                    </button>
                    <h1 id="headerTitle" class="deal-address">LOADING...</h1>
                </div>
                <div class="deal-right">
                    <span id="infoBarStage" class="deal-stage-holder"></span>
                    <span class="deal-meta-label">CLOSING</span><span id="infoBarClosingDate" class="deal-meta-value"></span>
                    <span class="deal-meta-label">DAYS REMAINING</span><span id="infoBarDays" class="deal-meta-value"></span>
                    <span id="headerAssetType" class="deal-asset-type"></span>
                    <span id="headerReference" class="deal-ref"></span>
                </div>
            </div>
            <div id="headerSubtitle" class="property-header-subtitle" style="display:none;"></div>
        </div>

        <!-- Split View: Carousel + Info Panel -->
        <div class="hero-split-view">
            <!-- Photo Carousel (Left) -->
            <div class="photo-carousel" id="leftCarousel">
                <div class="carousel-container" id="carouselContainer"></div>
                <button class="carousel-prev" onclick="changeSlide(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="carousel-nav" id="carouselNav"></div>
            </div>

            <!-- Photo Carousel (Right) -->
            <div class="photo-carousel photo-carousel-right" id="rightCarousel">
                <div class="carousel-container" id="carouselContainerRight"></div>
                <button class="carousel-next" onclick="changeSlide(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Section Nav (sticky) -->
        <nav class="section-nav">
            <a href="#overview" class="nav-pill">Overview</a>
            <a href="#financials" class="nav-pill">Financials</a>
            <a href="#property" class="nav-pill">Property</a>
            <a href="#tenancy" class="nav-pill">Tenancy</a>
            <a href="#returns" class="nav-pill">Returns</a>
            <a href="#strategy" class="nav-pill">Strategy</a>
        </nav>

        <!-- Content Layout: Main + Side rail -->
        <div class="content-layout">
            <!-- Main column -->
            <main class="main-column">

                <!-- Financials + Returns side by side -->
                <div class="two-up-grid">
                    <section id="financials" class="section-card">
                        <div class="section-header">Financial Metrics</div>
                        <div class="metrics-table" id="financialMetrics"></div>
                    </section>
                    <section id="returns" class="section-card">
                        <div class="section-header">Investment Returns</div>
                        <div class="investor-disclaimer">
                            *Cash Flow is defined as cash to investor after operating costs, fee sets, and debt.
                        </div>
                        <div class="returns-display" id="returnsDisplay"></div>
                    </section>
                </div>

                <!-- Property Details -->
                <section id="property" class="section-card">
                    <div class="section-header">Property Details</div>
                    <div class="property-details-grid">
                        <div class="detail-column" id="keyDatesColumn"></div>
                        <div class="detail-column" id="locationColumn"></div>
                        <div class="detail-column" id="buildingColumn"></div>
                    </div>
                </section>

                <!-- Tenancy -->
                <section id="tenancy" class="section-card">
                    <div class="section-header">Tenancy</div>
                    <div class="tenancy-grid">
                        <div class="tenancy-overview" id="tenancyOverview"></div>
                        <div class="tenant-cards" id="tenantCards"></div>
                    </div>
                </section>

                

                <!-- Strategy -->
                <section id="strategy" class="section-card">
                    <div class="section-header">Strategy</div>
                    <div class="strategy-grid">
                        <div>
                            <h3 class="subsection-title">Business Plan</h3>
                            <div class="strategy-content" id="businessPlan"></div>
                        </div>
                        <div>
                            <h3 class="subsection-title">Key Initiatives</h3>
                            <div class="kbi-list" id="kbiList"></div>
                        </div>
                    </div>
                </section>
            </main>

            <!-- Side rail -->
            <aside class="side-rail">
                <div class="side-card">
                    <div class="side-card-header">Deal Summary</div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Purchase Price</div>
                            <div class="summary-value" id="heroPrice">$0M</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Cap Rate</div>
                            <div class="summary-value" id="heroCapRate">0%</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Projected IRR</div>
                            <div class="summary-value" id="heroIRR">0%</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Quarterly / $1M</div>
                            <div class="summary-value" id="heroQuarterly">$0</div>
                        </div>
                    </div>

                    <div class="summary-chips">
                        <span class="chip"><span class="chip-label">Closing</span><span id="sidebarClosingDate" class="chip-value"></span></span>
                        <span class="chip"><span class="chip-label">Days Left</span><span id="sidebarDays" class="chip-value"></span></span>
                    </div>

                    <div class="summary-tags">
                        <span id="sidebarStage" class="deal-stage-holder"></span>
                        <span id="sidebarAssetType" class="tag">Asset</span>
                        <span id="sidebarReference" class="tag">REF</span>
                    </div>

                    <div class="cta-group">
                        <a href="/SE/Hub" class="cta-button primary">Back to Marketplace</a>
                        <button type="button" onclick="openFeesModal()" class="cta-button secondary">View Service Fees</button>
                    </div>
                </div>
                <div class="side-card">
                    <div class="side-card-header">Overview</div>
                    <div id="sidebarOverview" class="side-description">Loading description...</div>
                </div>
            </aside>
        </div>

        <!-- More Opportunities - Full Width Pre-Footer Section -->
        <section id="more-opportunities" class="opportunities-section">
            <div class="section-header">More Opportunities</div>
            <div class="opportunities-grid" id="opportunitiesGrid">
                <div class="loading-placeholder">Loading additional properties...</div>
            </div>
        </section>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalPropertyTitle">Property Location</h3>
                <button class="modal-close" onclick="closeMapModal()">&times;</button>
            </div>
            <div class="map-container">
                <iframe id="mapFrame" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
            </div>
        </div>
    </div>

    <!-- Service Fees Modal -->
    <div id="feesModal" class="modal" style="display:none;">
        <div class="modal-content fees-modal-content">
            <div class="modal-header">
                <h3>Service Fees</h3>
                <button class="modal-close" onclick="closeFeesModal()">&times;</button>
            </div>
            <div class="fees-modal-body" id="feesModalBody">
                <!-- Fee items populated dynamically -->
            </div>
            <div class="fees-modal-disclaimer">Fees subject to change; see offering docs.</div>
        </div>
    </div>

    <script>
    let currentSlideIndex = 0; // index of image pairs

    function showSlide(index) {
        const leftSlides = document.querySelectorAll('#carouselContainer .carousel-slide');
        const rightSlides = document.querySelectorAll('#carouselContainerRight .carousel-slide');
        const dots = document.querySelectorAll('#carouselNav .carousel-dot');
        leftSlides.forEach(s => s.classList.remove('active'));
        rightSlides.forEach(s => s.classList.remove('active'));
        dots.forEach(d => d.classList.remove('active'));
        if (leftSlides[index]) leftSlides[index].classList.add('active');
        if (rightSlides[index]) rightSlides[index].classList.add('active');
        if (dots[index]) dots[index].classList.add('active');
    }

    function changeSlide(direction) {
        const totalPairs = document.querySelectorAll('#carouselContainer .carousel-slide').length;
        if (!totalPairs) return;
        currentSlideIndex += direction;
        if (currentSlideIndex >= totalPairs) currentSlideIndex = 0;
        if (currentSlideIndex < 0) currentSlideIndex = totalPairs - 1;
        showSlide(currentSlideIndex);
    }

    function currentSlide(index) {
        currentSlideIndex = index - 1;
        showSlide(currentSlideIndex);
    }

    setInterval(() => changeSlide(1), 8000);

function calculateDaysUntilClosing(closeDate) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const close = new Date(closeDate);
    close.setHours(0, 0, 0, 0);
    return Math.max(0, Math.ceil((close - today) / (1000 * 3600 * 24)));
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const d = new Date(dateString);
    return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
}

function formatCurrency(value, decimals = 2) {
    if (!value && value !== 0) return 'N/A';
    return value.toLocaleString('en-US', {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
}

function populateTemplate(property) {
    if (!property) return;
    document.title = `${property.title} - Deal Details | SimpleEXCHANGE`;
    
    // Header
    const fullAddress = [
        property.address,
        property.location?.city,
        property.location?.state
    ].filter(Boolean).join(', ');
    
    document.getElementById('headerTitle').textContent = fullAddress.toUpperCase() || 'PROPERTY ADDRESS';
    
    const assetType = property.type?.toLowerCase() === 'multifamily' ? 'Multifamily' :
                     property.type?.toLowerCase() === 'office' ? 'Office' :
                     property.type?.toLowerCase() === 'retail' ? 'Retail' :
                     property.type?.toLowerCase() === 'industrial' ? 'Industrial' :
                     property.type || 'Asset';
    document.getElementById('headerAssetType').textContent = assetType.toUpperCase();
    document.getElementById('headerReference').textContent = `REF: ${property.referenceNumber || 'N/A'}`;
    // Mirror to sidebar if present
    const sidebarAsset = document.getElementById('sidebarAssetType');
    if (sidebarAsset) sidebarAsset.textContent = assetType.toUpperCase();
    const sidebarRef = document.getElementById('sidebarReference');
    if (sidebarRef) sidebarRef.textContent = `REF: ${property.referenceNumber || 'N/A'}`;

    // Subtitle
    const subtitleElement = document.getElementById('headerSubtitle');
    if (property.propertyHeader) {
        const truncatedHeader = property.propertyHeader.length > 180 ?
            property.propertyHeader.substring(0, 177) + '...' : property.propertyHeader;
        subtitleElement.textContent = truncatedHeader;
        subtitleElement.style.display = 'block';
    }

    // Info Bar
    const daysUntilClosing = calculateDaysUntilClosing(property.closeDate);
    document.getElementById('infoBarDays').textContent = daysUntilClosing;
    document.getElementById('infoBarClosingDate').textContent = formatDate(property.closeDate);
    const sidebarDays = document.getElementById('sidebarDays');
    if (sidebarDays) sidebarDays.textContent = daysUntilClosing;
    const sidebarClosing = document.getElementById('sidebarClosingDate');
    if (sidebarClosing) sidebarClosing.textContent = formatDate(property.closeDate);

    // Stage Badge
    const infoBarStage = document.getElementById('infoBarStage');
    if (property.dealStage) {
        infoBarStage.innerHTML = `<span class="property-stage-badge">${property.dealStage}</span>`;
        const sidebarStage = document.getElementById('sidebarStage');
        if (sidebarStage) sidebarStage.innerHTML = `<span class="property-stage-badge">${property.dealStage}</span>`;
    }

    // Carousel (two-at-a-time pairs)
    const leftContainer = document.getElementById('carouselContainer');
    const rightContainer = document.getElementById('carouselContainerRight');
    const nav = document.getElementById('carouselNav');
    leftContainer.innerHTML = '';
    rightContainer.innerHTML = '';
    nav.innerHTML = '';
    if (property.images?.length) {
        const imgs = property.images;
        const totalPairs = Math.ceil(imgs.length / 2);
        for (let p = 0; p < totalPairs; p++) {
            const iLeft = p * 2;
            const iRight = iLeft + 1;

            const leftSlide = document.createElement('div');
            leftSlide.className = p === 0 ? 'carousel-slide active' : 'carousel-slide';
            leftSlide.innerHTML = `<img src="${imgs[iLeft]}" alt="${property.title} image ${iLeft+1}">`;
            leftContainer.appendChild(leftSlide);

            const rightSlide = document.createElement('div');
            rightSlide.className = p === 0 ? 'carousel-slide active' : 'carousel-slide';
            const wrappedRightIndex = imgs[iRight] ? iRight : (imgs.length ? 0 : null);
            if (wrappedRightIndex !== null) {
                rightSlide.innerHTML = `<img src="${imgs[wrappedRightIndex]}" alt="${property.title} image ${wrappedRightIndex+1}">`;
            }
            rightContainer.appendChild(rightSlide);

            const dot = document.createElement('div');
            dot.className = p === 0 ? 'carousel-dot active' : 'carousel-dot';
            dot.onclick = () => currentSlide(p+1);
            nav.appendChild(dot);
        }
    }

    // Hero Metrics
    document.getElementById('heroPrice').textContent = property.financial?.purchasePrice ? 
        `$${(property.financial.purchasePrice/1e6).toFixed(1)}M` : 'N/A';
    document.getElementById('heroCapRate').textContent = property.financial?.capRate ? 
        `${property.financial.capRate.toFixed(1)}%` : 'N/A';
    document.getElementById('heroIRR').textContent = property.returns?.projectedIRR ? 
        `${property.returns.projectedIRR.toFixed(1)}%` : 'N/A';
    
    const per100k = property.financial?.per100k || 0;
    const quarterlyAmount = (per100k * 10 * 3);
    const quarterlyFormatted = formatCurrency(quarterlyAmount, 0);
    document.getElementById('heroQuarterly').textContent = `$${quarterlyFormatted}`;

    // Description with Location Highlights combined (works even if main description section removed)
    let combinedDescription = property.heroSummary || property.propertyHeader || 'No description available.';
    if (property.location?.locationHighlights) {
        combinedDescription += ' ' + property.location.locationHighlights;
    }
    const descriptionEl = document.getElementById('propertyDescription');
    if (descriptionEl) descriptionEl.textContent = combinedDescription;
    const sidebarOverview = document.getElementById('sidebarOverview');
    if (sidebarOverview) sidebarOverview.textContent = combinedDescription;

    // Financial Metrics Table
    const financialMetrics = document.getElementById('financialMetrics');
    if (financialMetrics && property.financial) {
        const metrics = [
            ['Purchase Price', property.financial.purchasePrice ? `$${(property.financial.purchasePrice/1e6).toFixed(2)}M` : 'N/A',
             'Cap Rate', property.financial.capRate ? `${property.financial.capRate.toFixed(2)}%` : 'N/A'],
            ['Current NOI', property.financial.currentNOI ? `$${formatCurrency(property.financial.currentNOI/1000)}K` : 'N/A',
             'Debt Amount', property.financial.debtAmount ? `$${(property.financial.debtAmount/1e6).toFixed(2)}M` : 'N/A'],
            ['LTV', property.financial.ltv ? `${property.financial.ltv.toFixed(2)}%` : 'N/A',
             'DSCR', property.financial.dscr ? property.financial.dscr.toFixed(2) : 'N/A'],
            ['Cash-on-Cash', property.financial.estCashOnCash ? `${property.financial.estCashOnCash.toFixed(2)}%` : 'N/A',
             'IRR', property.returns?.projectedIRR ? `${property.returns.projectedIRR.toFixed(2)}%` : 'N/A']
        ];

        financialMetrics.innerHTML = metrics.map(row => `
            <div class="metrics-row">
                <span class="label">${row[0]}</span>
                <span class="value">${row[1]}</span>
                <span class="label">${row[2]}</span>
                <span class="value">${row[3]}</span>
            </div>
        `).join('');
    }

    // Property Details - Key Dates
    const keyDatesColumn = document.getElementById('keyDatesColumn');
    if (keyDatesColumn) {
        const dates = [
            ['LOI Date', formatDate(property.loiDate)],
            ['PSA Date', formatDate(property.psaDate)],
            ['DD End', formatDate(property.ddEndDate)],
            ['Closing', formatDate(property.closeDate)]
        ];
        keyDatesColumn.innerHTML = `<h3 style="color: rgba(255, 255, 255, 0.7); font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Key Dates</h3>` +
            dates.map(d => `<div class="detail-item"><span class="detail-label">${d[0]}</span><span class="detail-value">${d[1]}</span></div>`).join('');
    }

    // Property Details - Location
    const locationColumn = document.getElementById('locationColumn');
    if (locationColumn && property.location) {
        const location = [
            ['City', property.location.city || 'N/A'],
            ['State', property.location.state || 'N/A'],
            ['ZIP', property.location.zipCode || 'N/A'],
            ['Submarket', property.location.submarket || 'N/A']
        ];
        locationColumn.innerHTML = `<h3 style="color: rgba(255, 255, 255, 0.7); font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Location</h3>` +
            location.map(l => `<div class="detail-item"><span class="detail-label">${l[0]}</span><span class="detail-value">${l[1]}</span></div>`).join('');
    }

    // Property Details - Building
    const buildingColumn = document.getElementById('buildingColumn');
    if (buildingColumn && property.building) {
        const building = [
            ['Total SF', property.building.totalSF?.toLocaleString() || 'N/A'],
            ['Acres', property.building.acres != null ? property.building.acres.toFixed(2) : 'N/A'],
            ['Vacancy', property.building.vacancy != null ? `${property.building.vacancy.toFixed(1)}%` : 'N/A'],
            ['WALT', property.building.walt != null ? `${property.building.walt.toFixed(1)} Yrs` : 'N/A']
        ];
        buildingColumn.innerHTML = `<h3 style="color: rgba(255, 255, 255, 0.7); font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Building</h3>` +
            building.map(b => `<div class="detail-item"><span class="detail-label">${b[0]}</span><span class="detail-value">${b[1]}</span></div>`).join('');
    }

    // Tenancy Overview
    const tenancyOverview = document.getElementById('tenancyOverview');
    if (tenancyOverview && property.tenancy) {
        tenancyOverview.innerHTML = `
            <div class="tenancy-stat">
                <div class="tenancy-stat-value">${property.tenancy.numTenants || 'N/A'}</div>
                <div class="tenancy-stat-label">Tenants</div>
            </div>
            <div class="tenancy-stat">
                <div class="tenancy-stat-value">${property.tenancy.occupancyPercent ? property.tenancy.occupancyPercent.toFixed(1) + '%' : 'N/A'}</div>
                <div class="tenancy-stat-label">Occupancy</div>
            </div>
            <div class="tenancy-stat">
                <div class="tenancy-stat-value">${property.tenancy.leaseStructure || 'N/A'}</div>
                <div class="tenancy-stat-label">Lease Type</div>
            </div>
        `;
    }

    // Top Tenants - compact horizontal layout
    const tenantCards = document.getElementById('tenantCards');
    if (tenantCards && property.tenancy) {
        tenantCards.innerHTML = '';
        [property.tenancy.tenant1, property.tenancy.tenant2, property.tenancy.tenant3].forEach((tenant, index) => {
            if (tenant && tenant.name) {
                const card = document.createElement('div');
                card.className = 'tenant-card';
                card.innerHTML = `
                    <div class="tenant-name">${tenant.name}</div>
                    <div class="tenant-card-content">
                        <div class="tenant-detail">
                            <span class="tenant-detail-label">SF Leased</span>
                            <span class="tenant-detail-value">${tenant.sf?.toLocaleString() || 'N/A'}</span>
                        </div>
                        <div class="tenant-detail">
                            <span class="tenant-detail-label">% of NRA</span>
                            <span class="tenant-detail-value">${tenant.percent ? tenant.percent.toFixed(1) + '%' : 'N/A'}</span>
                        </div>
                        <div class="tenant-detail">
                            <span class="tenant-detail-label">Expiry</span>
                            <span class="tenant-detail-value">${formatDate(tenant.expiry)}</span>
                        </div>
                        <div class="tenant-detail">
                            <span class="tenant-detail-label">Guarantee</span>
                            <span class="tenant-detail-value">${tenant.guarantee || 'N/A'}</span>
                        </div>
                        <div class="tenant-detail">
                            <span class="tenant-detail-label">Structure</span>
                            <span class="tenant-detail-value">${tenant.leaseStructure || 'N/A'}</span>
                        </div>
                    </div>
                `;
                tenantCards.appendChild(card);
            }
        });
    }

    // Returns Display
    const returnsDisplay = document.getElementById('returnsDisplay');
    if (returnsDisplay && property.financial) {
        const monthlyEquivalent = (per100k * 10);
        const monthlyFormatted = formatCurrency(monthlyEquivalent, 0);
        const quarterlyFormatted2 = formatCurrency(quarterlyAmount, 0);
        
        returnsDisplay.innerHTML = `
            <div class="return-item">
                <div class="return-value">$${monthlyFormatted}</div>
                <div class="return-label">Monthly</div>
                <div class="return-sublabel">Per $1M Investment</div>
            </div>
            <div class="return-item">
                <div class="return-value">$${quarterlyFormatted2}</div>
                <div class="return-label">Quarterly</div>
                <div class="return-sublabel">Per $1M Investment</div>
            </div>
        `;
    }

    // Business Plan
    const businessPlan = document.getElementById('businessPlan');
    if (businessPlan) {
        businessPlan.textContent = property.businessPlan || 'No business plan available.';
    }

    // KBIs
    const kbiList = document.getElementById('kbiList');
    if (kbiList && property.kbis) {
        kbiList.innerHTML = '';
        [property.kbis.kbi1, property.kbis.kbi2, property.kbis.kbi3, property.kbis.kbi4].forEach(kbi => {
            if (kbi) {
                const div = document.createElement('div');
                div.className = 'kbi-item';
                div.textContent = kbi;
                kbiList.appendChild(div);
            }
        });
    }

    window.currentProperty = property;
}

// Fetch and display additional opportunities
async function loadMoreOpportunities(currentPropertyId) {
    const container = document.getElementById('opportunitiesGrid');
    if (!container) return;
    
    try {
        const res = await fetch('/api/properties/');
        if (!res.ok) throw new Error('Failed to load properties');
        const properties = await res.json();
        
        // Filter out current property and get up to 3 others
        const others = properties
            .filter(p => p.id !== currentPropertyId)
            .slice(0, 3);
        
        // Use placeholder properties if none exist
        const displayProperties = others.length > 0 ? others : [
            {
                id: 'placeholder-1',
                title: 'Diversified Portfolio',
                type: 'Multifamily',
                location: { city: 'Fort Worth', state: 'TX' },
                financial: { purchasePrice: 2750000, capRate: 6.8 },
                returns: { projectedIRR: 16.5 },
                dealStage: '103 Exchange Qualified',
                images: ['/static/placeholder-property.jpg']
            },
            {
                id: 'placeholder-2',
                title: 'Bay Industrial 96 DST',
                type: 'Industrial',
                location: { city: 'San Jose', state: 'CA' },
                financial: { purchasePrice: 4200000, capRate: 5.2 },
                returns: { projectedIRR: 14.8 },
                dealStage: '0% All-Cash Offering',
                images: ['/static/placeholder-property.jpg']
            },
            {
                id: 'placeholder-3',
                title: 'Essential Net Lease 191 DST',
                type: 'Retail',
                location: { city: 'Phoenix', state: 'AZ' },
                financial: { purchasePrice: 3100000, capRate: 7.1 },
                returns: { projectedIRR: 15.2 },
                dealStage: '103 Exchange Qualified',
                images: ['/static/placeholder-property.jpg']
            }
        ];
        
        container.innerHTML = displayProperties.map(prop => {
            const assetType = prop.type || 'Property';
            const price = prop.financial?.purchasePrice ? 
                `$${(prop.financial.purchasePrice/1e6).toFixed(1)}M` : 'TBD';
            const capRate = prop.financial?.capRate ? 
                `${prop.financial.capRate.toFixed(1)}%` : 'N/A';
            const irr = prop.returns?.projectedIRR ? 
                `${prop.returns.projectedIRR.toFixed(1)}%` : 'N/A';
            const location = [prop.location?.city, prop.location?.state]
                .filter(Boolean).join(', ') || 'Location TBD';
            const imageUrl = prop.images?.[0] || '/static/placeholder-property.jpg';
            const isPlaceholder = prop.id.toString().startsWith('placeholder');
            
            return `
                <div class="opportunity-card" ${!isPlaceholder ? `onclick="window.location.href='/deal-detail/${prop.id}/'"` : ''}>
                    <img src="${imageUrl}" alt="${prop.title}" class="opportunity-image">
                    <div class="opportunity-content">
                        <div class="opportunity-type">${assetType}</div>
                        <h3 class="opportunity-title">${location}</h3>
                        <div class="opportunity-metrics">
                            <div class="opportunity-metric">
                                <span class="opportunity-metric-label">Price</span>
                                <span class="opportunity-metric-value">${price}</span>
                            </div>
                            <div class="opportunity-metric">
                                <span class="opportunity-metric-label">Cap Rate</span>
                                <span class="opportunity-metric-value">${capRate}</span>
                            </div>
                            <div class="opportunity-metric">
                                <span class="opportunity-metric-label">IRR</span>
                                <span class="opportunity-metric-value">${irr}</span>
                            </div>
                            <div class="opportunity-metric">
                                <span class="opportunity-metric-label">Status</span>
                                <span class="opportunity-metric-value" style="font-size: 0.75rem;">${prop.dealStage || 'Active'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch(err) {
        console.error('Error loading opportunities:', err);
        // Use placeholders on error
        loadMoreOpportunities.call(this, currentPropertyId);
    }
}

function openMapModal() {
    if (!window.currentProperty) return;
    const modal = document.getElementById('mapModal');
    const frame = document.getElementById('mapFrame');
    const title = document.getElementById('modalPropertyTitle');
    const encoded = encodeURIComponent(window.currentProperty.address || '');
    frame.src = `https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encoded}&zoom=15&maptype=satellite`;
    title.textContent = window.currentProperty.title || 'Property';
    modal.style.display = 'block';
}

function closeMapModal() {
    const modal = document.getElementById('mapModal');
    const frame = document.getElementById('mapFrame');
    modal.style.display = 'none';
    frame.src = '';
}

window.onclick = e => {
    if (e.target === document.getElementById('mapModal')) closeMapModal();
}

async function loadPropertyData() {
    const parts = window.location.pathname.split('/');
    const propertyId = parts[parts.indexOf('deal-detail') + 1];
    if (!propertyId) {
        console.error('No property ID');
        return;
    }
    try {
        const res = await fetch(`/api/properties/${propertyId}/`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        populateTemplate(data);
        // Load additional opportunities after main property loads
        loadMoreOpportunities(propertyId);
    } catch(err) {
        console.error('Error:', err);
        document.body.innerHTML = `
            <div style="text-align:center; padding:50px; color: white;">
                <h1>Property Not Found</h1>
                <p>${err.message}</p>
                <a href="/deals/" style="color: #3B78BD;">â† Back to Marketplace</a>
            </div>
        `;
    }
}

document.addEventListener('DOMContentLoaded', loadPropertyData);

// ---- Service Fees Modal Logic ----
function openFeesModal() {
    const modal = document.getElementById('feesModal');
    if (!window.currentProperty) return;
    populateServiceFees(window.currentProperty.fees, window.currentProperty.financial?.purchasePrice, window.currentProperty.financial?.currentNOI);
    modal.style.display = 'block';
}

function closeFeesModal() {
    const modal = document.getElementById('feesModal');
    modal.style.display = 'none';
}

function populateServiceFees(fees, purchasePrice, currentNOI) {
    const body = document.getElementById('feesModalBody');
    if (!body) return;
    if (!fees) { body.innerHTML = '<div style="padding:1rem;">No fee data available.</div>'; return; }

    // Helper formatters
    const fmtPct = v => (v != null ? v.toFixed(2) + '%': '0.00%');
    const fmtMoney = v => '$' + (v != null ? Number(v).toLocaleString() : '0');

    // Build list according to backend structure (exchange, manage, advisory, bricks, spaces, broker, creport)
    const items = [
        ['Exchange / DST Sponsor', fees.exchange?.rate, fees.exchange?.amount, 'Per Equity'],
        ['Asset Manager', fees.manage?.rate, fees.manage?.amount, 'Annual NOI'],
        ['Advisory', fees.advisory?.rate, fees.advisory?.amount, 'Asset Value'],
        ['Bricks (Construction)', fees.bricks?.rate, fees.bricks?.amount, 'As Needed'],
        ['Spaces (Leasing)', fees.spaces?.rate, fees.spaces?.amount, 'Leasing Fee'],
        ['Broker Commission', fees.broker?.rate, fees.broker?.amount, 'Exit Fee'],
        ['CRE Report', fees.creport?.rate, fees.creport?.amount, 'Loan Amount']
    ].filter(row => row.some(v => v !== undefined));

    // Map labels to logo asset paths (Django static). Fallback is first letter.
    const logoMap = {
        'Exchange / DST Sponsor': '{% static "simpleexchangeprocess.svg" %}',
        'Asset Manager': '{% static "managelogo.svg" %}',
        'Advisory': '{% static "salogo.svg" %}',
        'Bricks (Construction)': '{% static "brickslogo.svg" %}', // fallback parent brand
        'Spaces (Leasing)': '{% static "spaceslogo.svg" %}',      // no dedicated logo yet
        'Broker Commission': '{% static "brokerlogo.svg" %}',     // generic brand usage
        'CRE Report': '{% static "creditlogo.svg" %}'             // generic brand usage
    };

    body.innerHTML = items.map(([label, rate, amount, basis]) => {
        const pct = rate != null ? rate.toFixed(2) + '%': '0.00%';
        let amountDisplay = '';
        if (amount != null) {
            amountDisplay = fmtMoney(amount);
        } else if (purchasePrice && rate != null && /Asset/i.test(basis)) {
            amountDisplay = fmtMoney(purchasePrice * (rate/100));
        } else if (currentNOI && rate != null && /NOI/i.test(basis)) {
            amountDisplay = fmtMoney(currentNOI * (rate/100));
        }
        const logo = logoMap[label];
        const iconMarkup = logo ? `<img src="${logo}" alt="${label} logo" loading="lazy">` : label.charAt(0);
        return `<div class="fee-item">
            <div class="fee-icon">${iconMarkup}</div>
            <div class="fee-details">
                <div class="fee-name">${label}</div>
                <div class="fee-rate">${pct} ${basis}${amountDisplay? ' / '+amountDisplay:''}</div>
            </div>
        </div>`;
    }).join('');
}

// Close fees modal when clicking outside
window.addEventListener('click', e => { if (e.target === document.getElementById('feesModal')) closeFeesModal(); });
    </script>
{% endblock %}